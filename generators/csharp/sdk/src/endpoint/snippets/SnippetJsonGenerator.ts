import { WithGeneration } from "@fern-api/csharp-codegen";
import { FernGeneratorExec } from "@fern-fern/generator-exec-sdk";
import { HttpEndpoint } from "@fern-fern/ir-sdk/api";
import urlJoin from "url-join";
import { RootClientGenerator } from "../../root-client/RootClientGenerator";
import { SdkGeneratorContext } from "../../SdkGeneratorContext";
import { SingleEndpointSnippet } from "./EndpointSnippetsGenerator";

export class SnippetJsonGenerator extends WithGeneration {
    private readonly context: SdkGeneratorContext;
    private readonly rootClientGenerator: RootClientGenerator;
    constructor({ context }: { context: SdkGeneratorContext }) {
        super(context.generation);
        this.context = context;
        this.rootClientGenerator = new RootClientGenerator(context);
    }

    public async generate(): Promise<FernGeneratorExec.Snippets> {
        const rootClientSnippet = await this.rootClientGenerator
            .generateExampleClientInstantiationSnippet({ asSnippet: true })
            .toFormattedSnippetAsync({
                allNamespaceSegments: this.context.getAllNamespaceSegments(),
                allTypeClassReferences: this.context.getAllTypeClassReferences(),
                generation: this.generation,
                formatter: this.context.formatter
            });
        const rootClientImportList = rootClientSnippet.imports?.split("\n") ?? [];

        function getCsharpSnippet(endpointSnippet: SingleEndpointSnippet, isPager: boolean): string {
            let snippet = "";
            const snippetImportList = endpointSnippet.imports?.split("\n") ?? [];
            const uniqueOrderedImports = Array.from(new Set([...rootClientImportList, ...snippetImportList]))
                .filter((importString) => importString !== "")
                .sort();
            snippet = `${snippet}${uniqueOrderedImports.join("\n")}\n\nvar client = ${rootClientSnippet.body}`;

            if (isPager) {
                snippet = `${snippet}var items = `;
            }

            snippet = `${snippet}${endpointSnippet.endpointCall}`;

            if (isPager) {
                snippet = `${snippet}\nawait foreach (var item in items)
{
    // do something with item
}\n`;
            }
            return snippet;
        }

        const isPaginationEnabled = this.context.config.generatePaginatedClients ?? false;
        const endpoints: FernGeneratorExec.Endpoint[] = await Promise.all(
            Object.values(this.context.ir.services).flatMap((service) =>
                service.endpoints.map(async (httpEndpoint) => {
                    const isPager = isPaginationEnabled && httpEndpoint.pagination != null;
                    const isStreaming =
                        httpEndpoint.response?.body?._visit({
                            streaming: () => true,
                            json: () => false,
                            fileDownload: () => false,
                            text: () => false,
                            bytes: () => false,
                            streamParameter: () => false,
                            _other: () => false
                        }) ?? false;
                    const snippets = this.getSnippetsForEndpoint(httpEndpoint.id);
                    return snippets.map((endpointSnippet) => {
                        const csharpSnippet = getCsharpSnippet(endpointSnippet, isPager || isStreaming);
                        return {
                            exampleIdentifier: endpointSnippet?.exampleIdentifier,
                            id: {
                                path: FernGeneratorExec.EndpointPath(this.getFullPathForEndpoint(httpEndpoint)),
                                method: httpEndpoint.method,
                                identifierOverride: httpEndpoint.id
                            },
                            snippet: FernGeneratorExec.EndpointSnippet.csharp({
                                client: csharpSnippet
                            })
                        };
                    });
                })
            )
        ).then((endpoints) => endpoints.flat());

        return {
            types: {},
            endpoints
        };
    }

    private getSnippetsForEndpoint(endpointId: string): SingleEndpointSnippet[] {
        const snippetsForEndpoint = this.context.snippetGenerator.getSnippetsForEndpoint(endpointId);
        if (snippetsForEndpoint == null) {
            return [];
        }
        const { autogenerated, userSpecified } = snippetsForEndpoint;
        return userSpecified.length > 0 ? [...userSpecified] : autogenerated[0] != null ? [autogenerated[0]] : [];
    }

    // copied from ts generator:
    // TODO(dsinghvi): HACKHACK Move this to IR
    private getFullPathForEndpoint(endpoint: HttpEndpoint): string {
        let url = "";
        if (endpoint.fullPath.head.length > 0) {
            url = urlJoin(url, endpoint.fullPath.head);
        }
        for (const part of endpoint.fullPath.parts) {
            url = urlJoin(url, `{${part.pathParameter}}`);
            if (part.tail.length > 0) {
                url = urlJoin(url, part.tail);
            }
        }
        return url.startsWith("/") ? url : `/${url}`;
    }
}
