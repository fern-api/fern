// this is the parsed config shape. to view the allowed options for generators.yml,
// see SdkCustomConfigSchema.ts

export type SerializerType = "zurg" | "zod" | "yup" | "none";

export interface SdkCustomConfig {
    useBrandedStringAliases: boolean;
    isPackagePrivate: boolean;
    neverThrowErrors: boolean;
    namespaceExport: string | undefined;
    outputEsm: boolean;
    outputSourceFiles: boolean;
    includeCredentialsOnCrossOriginRequests: boolean;
    shouldBundle: boolean;
    allowCustomFetcher: boolean;
    shouldGenerateWebsocketClients: boolean;
    includeUtilsOnUnionMembers: boolean;
    includeOtherInUnionTypes: boolean;
    enableForwardCompatibleEnums: boolean;
    requireDefaultEnvironment: boolean;
    defaultTimeoutInSeconds: number | "infinity" | undefined;
    skipResponseValidation: boolean;
    extraDependencies: Record<string, string>;
    extraDevDependencies: Record<string, string>;
    extraPeerDependencies: Record<string, string>;
    extraPeerDependenciesMeta: Record<string, unknown>;
    treatUnknownAsAny: boolean;
    includeContentHeadersOnFileDownloadResponse: boolean;
    noSerdeLayer: boolean;
    noOptionalProperties: boolean;
    includeApiReference: boolean | undefined;
    tolerateRepublish: boolean;
    retainOriginalCasing: boolean | undefined;
    allowExtraFields: boolean | undefined;
    inlineFileProperties: boolean | undefined;
    inlinePathParameters: boolean | undefined;
    enableInlineTypes: boolean | undefined;
    packageJson: Record<string, unknown> | undefined;
    publishToJsr: boolean | undefined;
    omitUndefined: boolean | undefined;
    writeUnitTests: boolean | undefined;
    generateWireTests: boolean | undefined;
    noScripts: boolean | undefined;
    useBigInt: boolean | undefined;
    useLegacyExports: boolean | undefined;
    streamType: "wrapper" | "web";
    fileResponseType: "stream" | "binary-response";
    formDataSupport: "Node16" | "Node18";
    fetchSupport: "node-fetch" | "native";
    packagePath: string | undefined;
    omitFernHeaders: boolean | undefined;
    useDefaultRequestParameterValues: boolean | undefined;
    packageManager: "pnpm" | "yarn";
    generateReadWriteOnlyTypes: boolean;
    flattenRequestParameters: boolean | undefined;
    exportAllRequestsAtRoot: boolean | undefined;
    testFramework: "jest" | "vitest";
    consolidateTypeFiles: boolean | undefined;
    generateEndpointMetadata: boolean | undefined;
    wireTestsFallbackToAutoGeneratedErrorExamples: boolean | undefined;
    linter: "biome" | "oxlint" | "none";
    formatter: "prettier" | "biome" | "oxfmt";
    parameterNaming: "originalName" | "wireValue" | "camelCase" | "snakeCase" | "default";
    generateSubpackageExports: boolean | undefined;
    offsetSemantics: "item-index" | "page-index";

    // Serializer configuration: "zurg" (legacy), "zod", "yup", or "none" (disabled)
    serializer: SerializerType | undefined;

    // Customer-facing schema export config
    exportSchemas: "zod" | "yup" | false | undefined;
}

/**
 * Resolve the effective serializer type from config.
 * - If noSerdeLayer is true, returns "none"
 * - If serializer is specified, returns that value
 * - Default is "zurg" for backward compatibility
 *
 * Throws if noSerdeLayer is false but serializer is "none" (invalid combo)
 */
export function resolveSerializer(config: SdkCustomConfig): SerializerType {
    // noSerdeLayer: true means no serialization
    if (config.noSerdeLayer) {
        return "none";
    }

    // If serializer is explicitly set
    if (config.serializer != null) {
        // Validate: can't have noSerdeLayer=false with serializer="none"
        if (config.serializer === "none") {
            throw new Error(
                'Invalid config: serializer is "none" but noSerdeLayer is not true. ' +
                    "Either set noSerdeLayer: true or choose a serializer (zurg, zod, yup)."
            );
        }
        return config.serializer;
    }

    // Default to zurg for backward compatibility
    return "zurg";
}

/**
 * Returns true if serialization is enabled (serializer is not "none")
 */
export function isSerializationEnabled(config: SdkCustomConfig): boolean {
    return resolveSerializer(config) !== "none";
}
