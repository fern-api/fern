import { assertDefined } from "@fern-api/core-utils";
import { LiteralEnum, Referencer, swift } from "@fern-api/swift-codegen";
import { EndpointSnippetGenerator } from "@fern-api/swift-dynamic-snippets";
import { dynamic, ExampleEndpointCall, ExampleTypeReference, HttpEndpoint } from "@fern-fern/ir-sdk/api";
import { SdkGeneratorContext } from "../../SdkGeneratorContext";
import { convertDynamicEndpointSnippetRequest } from "../../utils/convertEndpointSnippetRequest";

export declare namespace WireTestFunctionGenerator {
    interface Args {
        parentSymbol: swift.Symbol;
        endpoint: HttpEndpoint;
        endpointSnippetGenerator: EndpointSnippetGenerator;
        dynamicIr: dynamic.DynamicIntermediateRepresentation;
        sdkGeneratorContext: SdkGeneratorContext;
    }
}

export class WireTestFunctionGenerator {
    private readonly parentSymbol: swift.Symbol;
    private readonly endpoint: HttpEndpoint;
    private readonly endpointSnippetGenerator: EndpointSnippetGenerator;
    private readonly dynamicIr: dynamic.DynamicIntermediateRepresentation;
    private readonly sdkGeneratorContext: SdkGeneratorContext;
    private readonly exampleEndpointCallsById: Record<string, ExampleEndpointCall>;
    private readonly referencer: Referencer;

    public constructor({
        parentSymbol,
        endpoint,
        endpointSnippetGenerator,
        dynamicIr,
        sdkGeneratorContext
    }: WireTestFunctionGenerator.Args) {
        this.parentSymbol = parentSymbol;
        this.endpoint = endpoint;
        this.endpointSnippetGenerator = endpointSnippetGenerator;
        this.dynamicIr = dynamicIr;
        this.sdkGeneratorContext = sdkGeneratorContext;
        this.exampleEndpointCallsById = this.buildExampleEndpointCallsById(endpoint);
        this.referencer = this.sdkGeneratorContext.createReferencer(this.parentSymbol);
    }

    private get dynamicEndpoint() {
        const dynamicEndpoint = this.dynamicIr.endpoints[this.endpoint.id];
        assertDefined(dynamicEndpoint, "Dynamic endpoint is required to generate wire tests.");
        return dynamicEndpoint;
    }

    private buildExampleEndpointCallsById(endpoint: HttpEndpoint) {
        return [
            ...endpoint.userSpecifiedExamples.map((example) => example.example).filter((example) => example != null),
            ...endpoint.autogeneratedExamples.map((example) => example.example)
        ].reduce(
            (acc, exampleEndpointCall) => {
                if (exampleEndpointCall.id != null) {
                    acc[exampleEndpointCall.id] = exampleEndpointCall;
                }
                return acc;
            },
            {} as Record<string, ExampleEndpointCall>
        );
    }

    public generateTestFunctionsForEndpoint(): swift.Method[] {
        return (this.dynamicEndpoint.examples ?? [])
            .map((endpointExample, endpointExampleIdx) => {
                const exampleEndpointCall = this.exampleEndpointCallsById[endpointExample.id];
                if (exampleEndpointCall == null || exampleEndpointCall.response.type === "error") {
                    return null;
                }
                const exampleTypeRef = exampleEndpointCall.response.value._visit({
                    body: (exampleTypeRef) => exampleTypeRef,
                    stream: () => null,
                    sse: () => null,
                    _other: () => null
                });
                if (exampleTypeRef == null) {
                    return null;
                }
                const statements: swift.Statement[] = [
                    swift.Statement.constantDeclaration({
                        unsafeName: "stub",
                        value: swift.Expression.structInitialization({ unsafeName: "HTTPStub" })
                    }),
                    swift.Statement.expressionStatement(
                        swift.Expression.methodCall({
                            target: swift.Expression.reference("stub"),
                            methodName: "setResponse",
                            arguments_: [
                                swift.functionArgument({
                                    label: "body",
                                    value: swift.Expression.structInitialization({
                                        unsafeName: "Data",
                                        arguments_: [
                                            swift.functionArgument({
                                                value: swift.Expression.memberAccess({
                                                    target: swift.Expression.stringLiteral(
                                                        // For String responses, the Swift SDK directly converts raw data to string (no JSON decoding)
                                                        // For other types (Date, UUID, etc.), the SDK uses JSON decoding, so we need valid JSON
                                                        `""\n${this.formatResponseBody(exampleTypeRef)}\n""`
                                                    ),
                                                    memberName: "utf8"
                                                })
                                            })
                                        ],
                                        multiline: true
                                    })
                                })
                            ],
                            multiline: true
                        })
                    ),
                    this.generateClientDeclaration(endpointExample),
                    swift.Statement.constantDeclaration({
                        unsafeName: "expectedResponse",
                        value: this.generateExampleResponse(exampleTypeRef, this.parentSymbol)
                    }),
                    this.generateEndpointMethodCallStatement(endpointExample),
                    swift.Statement.expressionStatement(
                        swift.Expression.try(
                            swift.Expression.functionCall({
                                unsafeName: "#require",
                                arguments_: [
                                    swift.functionArgument({
                                        value: swift.Expression.equals(
                                            swift.Expression.reference("response"),
                                            swift.Expression.reference("expectedResponse")
                                        )
                                    })
                                ]
                            })
                        )
                    )
                ];
                return swift.method({
                    attributes: [{ name: "Test" }],
                    unsafeName: `${this.endpoint.name.camelCase.unsafeName}${endpointExampleIdx + 1}`,
                    async: true,
                    throws: true,
                    returnType: this.referencer.referenceSwiftType("Void"),
                    body: swift.CodeBlock.withStatements(statements)
                });
            })
            .filter((method) => method != null);
    }

    private generateClientDeclaration(dynamicEndpointExample: dynamic.EndpointExample): swift.Statement {
        const endpointSnippetRequest = convertDynamicEndpointSnippetRequest(dynamicEndpointExample, {
            baseUrlFallback: "https://api.fern.com"
        });
        return this.endpointSnippetGenerator.generateRootClientInitializationStatement({
            auth: this.dynamicEndpoint.auth,
            snippet: endpointSnippetRequest,
            additionalArgs: [
                swift.functionArgument({
                    label: "urlSession",
                    value: swift.Expression.memberAccess({
                        target: swift.Expression.reference("stub"),
                        memberName: "urlSession"
                    })
                })
            ]
        });
    }

    private generateEndpointMethodCallStatement(dynamicEndpointExample: dynamic.EndpointExample): swift.Statement {
        const endpointSnippetRequest = convertDynamicEndpointSnippetRequest(dynamicEndpointExample);
        return swift.Statement.constantDeclaration({
            unsafeName: "response",
            value: this.endpointSnippetGenerator.generateEndpointMethodCallExpression({
                endpoint: this.dynamicEndpoint,
                snippet: endpointSnippetRequest,
                additionalArguments: [
                    swift.functionArgument({
                        label: "requestOptions",
                        value: swift.Expression.structInitialization({
                            unsafeName: "RequestOptions",
                            arguments_: [
                                swift.functionArgument({
                                    label: "additionalHeaders",
                                    value: swift.Expression.memberAccess({
                                        target: swift.Expression.reference("stub"),
                                        memberName: "headers"
                                    })
                                })
                            ]
                        })
                    })
                ]
            })
        });
    }

    private generateExampleResponse(
        exampleTypeRef: ExampleTypeReference,
        fromScope: swift.Symbol | string
    ): swift.Expression {
        return exampleTypeRef.shape._visit({
            container: (exampleContainer) =>
                exampleContainer._visit({
                    literal: (literalContainer) => {
                        return literalContainer.literal._visit({
                            string: (val) =>
                                swift.Expression.enumCaseShorthand(LiteralEnum.generateEnumCaseLabel(val.original)),
                            // Only string literals are supported
                            boolean: () => swift.Expression.nop(),
                            integer: () => swift.Expression.nop(),
                            uint: () => swift.Expression.nop(),
                            uint64: () => swift.Expression.nop(),
                            long: () => swift.Expression.nop(),
                            float: () => swift.Expression.nop(),
                            double: () => swift.Expression.nop(),
                            bigInteger: () => swift.Expression.nop(),
                            date: () => swift.Expression.nop(),
                            datetime: () => swift.Expression.nop(),
                            base64: () => swift.Expression.nop(),
                            uuid: () => swift.Expression.nop(),
                            _other: () => swift.Expression.nop()
                        });
                    },
                    map: (mapContainer) => {
                        return swift.Expression.dictionaryLiteral({
                            entries: mapContainer.map.map((kvPair) => [
                                this.generateExampleResponse(kvPair.key, fromScope),
                                this.generateExampleResponse(kvPair.value, fromScope)
                            ]),
                            multiline: true
                        });
                    },
                    set: (setContainer) => {
                        // Sets are converted to JSONValue in Swift
                        return swift.Expression.methodCall({
                            target: swift.Expression.reference("JSONValue"),
                            methodName: "array",
                            arguments_: [
                                swift.functionArgument({
                                    value: swift.Expression.arrayLiteral({
                                        elements: setContainer.set.map((element) =>
                                            this.generateJSONValueExampleResponse(element)
                                        ),
                                        multiline: setContainer.set.length > 1 ? true : undefined
                                    })
                                })
                            ]
                        });
                    },
                    nullable: (nullableContainer) => {
                        if (this.sdkGeneratorContext.customConfig.nullableAsOptional) {
                            const exampleTypeRef =
                                nullableContainer.nullable?.shape.type === "container" &&
                                nullableContainer.nullable.shape.container.type === "optional"
                                    ? nullableContainer.nullable.shape.container.optional
                                    : nullableContainer.nullable;
                            return swift.Expression.structInitialization({
                                unsafeName: "Optional",
                                arguments_: [
                                    swift.functionArgument({
                                        value:
                                            exampleTypeRef == null
                                                ? swift.Expression.nil()
                                                : this.generateExampleResponse(exampleTypeRef, fromScope)
                                    })
                                ]
                            });
                        }
                        if (nullableContainer.nullable == null) {
                            return swift.Expression.enumCaseShorthand("null");
                        }
                        return swift.Expression.methodCall({
                            target: swift.Expression.reference(
                                `Nullable<${this.getSwiftTypeReferenceForExampleTypeReference(nullableContainer.nullable, fromScope).toString()}>`
                            ),
                            methodName: "value",
                            arguments_: [
                                swift.functionArgument({
                                    value: this.generateExampleResponse(nullableContainer.nullable, fromScope)
                                })
                            ]
                        });
                    },
                    optional: (optionalContainer) => {
                        const inner = optionalContainer.optional;
                        const exampleTypeRef =
                            inner?.shape.type === "container"
                                ? inner.shape.container.type === "optional"
                                    ? inner.shape.container.optional
                                    : this.sdkGeneratorContext.customConfig.nullableAsOptional &&
                                        inner.shape.container.type === "nullable"
                                      ? inner.shape.container.nullable
                                      : inner
                                : inner;
                        return swift.Expression.structInitialization({
                            unsafeName: "Optional",
                            arguments_: [
                                swift.functionArgument({
                                    value:
                                        exampleTypeRef == null
                                            ? swift.Expression.nil()
                                            : this.generateExampleResponse(exampleTypeRef, fromScope)
                                })
                            ]
                        });
                    },
                    list: (listContainer) => {
                        return swift.Expression.arrayLiteral({
                            elements: listContainer.list.map((element) =>
                                this.generateExampleResponse(element, fromScope)
                            ),
                            multiline: true
                        });
                    },
                    _other: () => swift.Expression.nop()
                }),
            primitive: (examplePrimitive) =>
                examplePrimitive._visit({
                    string: (escapedString) => swift.Expression.stringLiteral(escapedString.original),
                    boolean: (bool) => swift.Expression.boolLiteral(bool),
                    integer: (value) => swift.Expression.numberLiteral(value),
                    uint: (value) => swift.Expression.numberLiteral(value),
                    uint64: (value) => swift.Expression.numberLiteral(value),
                    long: (value) => swift.Expression.numberLiteral(value),
                    float: (value) => swift.Expression.numberLiteral(value),
                    double: (value) => swift.Expression.numberLiteral(value),
                    bigInteger: (value) => swift.Expression.stringLiteral(value),
                    date: (value) => swift.Expression.calendarDateLiteral(value),
                    datetime: (value) => {
                        if (value.raw == null) {
                            return swift.Expression.nop();
                        }
                        const timestampMs = new Date(value.raw).getTime();
                        const timestampSec = Math.round(timestampMs / 1000);
                        const roundedDateTime = new Date(timestampSec * 1000).toISOString();
                        // Remove fractional seconds (.000Z -> Z) for Swift compatibility
                        const dateTimeWithoutFractional = roundedDateTime.replace(/\.\d{3}Z$/, "Z");
                        return swift.Expression.dateLiteral(dateTimeWithoutFractional);
                    },
                    base64: (value) => swift.Expression.stringLiteral(value),
                    uuid: (value) => swift.Expression.uuidLiteral(value),
                    _other: () => swift.Expression.nop()
                }),
            named: (exampleNamedType) => {
                const { typeId } = exampleNamedType.typeName;
                const symbol = this.sdkGeneratorContext.project.nameRegistry.getSchemaTypeSymbolOrThrow(typeId);
                return exampleNamedType.shape._visit({
                    alias: (exampleAliasType) => {
                        return this.generateExampleResponse(exampleAliasType.value, fromScope);
                    },
                    enum: (exampleEnumType) => {
                        // Use full type name to provide context for Swift type inference
                        return swift.Expression.memberAccess({
                            target: swift.Expression.reference(symbol.name),
                            memberName: exampleEnumType.value.name.camelCase.unsafeName
                        });
                    },
                    object: (exampleObjectType) => {
                        return swift.Expression.structInitialization({
                            unsafeName: symbol.name,
                            arguments_: exampleObjectType.properties
                                .map((property) => {
                                    if (
                                        property.value.shape.type === "container" &&
                                        property.value.shape.container.type === "optional" &&
                                        property.value.jsonExample === undefined
                                    ) {
                                        return null;
                                    }
                                    const exampleResponse = this.generateExampleResponse(property.value, fromScope);
                                    return swift.functionArgument({
                                        label: property.name.name.camelCase.unsafeName,
                                        value: exampleResponse
                                    });
                                })
                                .filter((arg) => arg != null),
                            multiline: true
                        });
                    },
                    union: (exampleUnionType) => {
                        // Use full type name to provide context for Swift type inference
                        return exampleUnionType.singleUnionType.shape._visit({
                            noProperties: () =>
                                swift.Expression.methodCall({
                                    target: swift.Expression.reference(symbol.name),
                                    methodName:
                                        exampleUnionType.singleUnionType.wireDiscriminantValue.name.camelCase
                                            .unsafeName,
                                    arguments_: [
                                        swift.functionArgument({
                                            value: swift.Expression.contextualMethodCall({
                                                methodName: "init",
                                                arguments_: []
                                            })
                                        })
                                    ]
                                }),
                            samePropertiesAsObject: (exampleObjectTypeWithId) =>
                                swift.Expression.methodCall({
                                    target: swift.Expression.reference(symbol.name),
                                    methodName:
                                        exampleUnionType.singleUnionType.wireDiscriminantValue.name.camelCase
                                            .unsafeName,
                                    arguments_: [
                                        swift.functionArgument({
                                            value: swift.Expression.contextualMethodCall({
                                                methodName: "init",
                                                arguments_: exampleObjectTypeWithId.object.properties
                                                    .map((property) => {
                                                        if (
                                                            property.value.shape.type === "container" &&
                                                            property.value.shape.container.type === "optional" &&
                                                            property.value.jsonExample === undefined
                                                        ) {
                                                            return null;
                                                        }
                                                        const exampleResponse = this.generateExampleResponse(
                                                            property.value,
                                                            fromScope
                                                        );
                                                        return swift.functionArgument({
                                                            label: property.name.name.camelCase.unsafeName,
                                                            value: exampleResponse
                                                        });
                                                    })
                                                    .filter((arg) => arg != null),
                                                multiline: true
                                            })
                                        })
                                    ],
                                    multiline: true
                                }),
                            singleProperty: (exampleTypeRef) => this.generateExampleResponse(exampleTypeRef, fromScope),
                            _other: () =>
                                swift.Expression.methodCall({
                                    target: swift.Expression.reference(symbol.name),
                                    methodName:
                                        exampleUnionType.singleUnionType.wireDiscriminantValue.name.camelCase
                                            .unsafeName,
                                    arguments_: []
                                })
                        });
                    },
                    undiscriminatedUnion: (exampleUnionType) => {
                        const swiftType = this.getSwiftTypeReferenceForExampleTypeReference(
                            exampleUnionType.singleUnionType,
                            fromScope
                        );
                        return swift.Expression.methodCall({
                            target: swift.Expression.reference(symbol.name),
                            methodName: this.sdkGeneratorContext.inferCaseNameForTypeReference(symbol, swiftType),
                            arguments_: [
                                swift.functionArgument({
                                    value: this.generateExampleResponse(exampleUnionType.singleUnionType, fromScope)
                                })
                            ],
                            multiline: true
                        });
                    },
                    _other: () => swift.Expression.nop()
                });
            },
            unknown: (val) => {
                return this.generateUnknownExampleResponse(val);
            },
            _other: () => swift.Expression.nop()
        });
    }

    public getSwiftTypeReferenceForExampleTypeReferenceFromTestModuleScope(
        typeReference: ExampleTypeReference
    ): swift.TypeReference {
        const symbol = this.sdkGeneratorContext.project.nameRegistry.getRegisteredTestModuleSymbolOrThrow();
        return this.getSwiftTypeReferenceForExampleTypeReference(typeReference, symbol);
    }

    private getSwiftTypeReferenceForExampleTypeReference(
        typeReference: ExampleTypeReference,
        fromScope: swift.Symbol | string
    ): swift.TypeReference {
        return typeReference.shape._visit({
            container: (exampleContainer) => {
                return exampleContainer._visit({
                    // TODO(kafkas): Implement this
                    literal: () => this.referencer.referenceAsIsType("JSONValue"),
                    map: (exampleMapContainer) =>
                        swift.TypeReference.dictionary(
                            this.sdkGeneratorContext.getSwiftTypeReferenceFromTestModuleScope(
                                exampleMapContainer.keyType
                            ),
                            this.sdkGeneratorContext.getSwiftTypeReferenceFromTestModuleScope(
                                exampleMapContainer.valueType
                            )
                        ),
                    set: () => this.referencer.referenceAsIsType("JSONValue"),
                    nullable: (exampleNullableContainer) =>
                        this.sdkGeneratorContext.customConfig.nullableAsOptional
                            ? swift.TypeReference.optional(
                                  this.sdkGeneratorContext.getSwiftTypeReferenceFromTestModuleScope(
                                      exampleNullableContainer.valueType
                                  )
                              )
                            : swift.TypeReference.nullable(
                                  this.sdkGeneratorContext.getSwiftTypeReferenceFromTestModuleScope(
                                      exampleNullableContainer.valueType
                                  )
                              ),
                    optional: (exampleOptionalContainer) =>
                        swift.TypeReference.optional(
                            this.sdkGeneratorContext.getSwiftTypeReferenceFromTestModuleScope(
                                exampleOptionalContainer.valueType
                            )
                        ),
                    list: (exampleListContainer) =>
                        swift.TypeReference.array(
                            this.sdkGeneratorContext.getSwiftTypeReferenceFromTestModuleScope(
                                exampleListContainer.itemType
                            )
                        ),
                    _other: () => this.referencer.referenceAsIsType("JSONValue")
                });
            },
            primitive: (examplePrimitive) => {
                return examplePrimitive._visit({
                    string: () => this.referencer.referenceSwiftType("String"),
                    boolean: () => this.referencer.referenceSwiftType("Bool"),
                    integer: () => this.referencer.referenceSwiftType("Int"),
                    uint: () => this.referencer.referenceSwiftType("UInt"),
                    uint64: () => this.referencer.referenceSwiftType("UInt64"),
                    long: () => this.referencer.referenceSwiftType("Int64"),
                    float: () => this.referencer.referenceSwiftType("Float"),
                    double: () => this.referencer.referenceSwiftType("Double"),
                    bigInteger: () => this.referencer.referenceSwiftType("String"),
                    date: () => this.referencer.referenceAsIsType("CalendarDate"),
                    datetime: () => this.referencer.referenceFoundationType("Date"),
                    base64: () => this.referencer.referenceSwiftType("String"),
                    uuid: () => this.referencer.referenceFoundationType("UUID"),
                    _other: () => this.referencer.referenceAsIsType("JSONValue")
                });
            },
            named: (exampleNamedType) => {
                const symbol = this.sdkGeneratorContext.project.nameRegistry.getSchemaTypeSymbolOrThrow(
                    exampleNamedType.typeName.typeId
                );
                return this.referencer.referenceType(symbol.id);
            },
            unknown: () => this.referencer.referenceAsIsType("JSONValue"),
            _other: () => this.referencer.referenceAsIsType("JSONValue")
        });
    }

    private generateJSONValueExampleResponse(exampleTypeRef: ExampleTypeReference): swift.Expression {
        // Convert an ExampleTypeReference to a JSONValue expression
        return exampleTypeRef.shape._visit({
            container: (exampleContainer) =>
                exampleContainer._visit({
                    literal: (literalContainer) => {
                        return literalContainer.literal._visit({
                            string: (val) =>
                                swift.Expression.methodCall({
                                    target: swift.Expression.reference("JSONValue"),
                                    methodName: "string",
                                    arguments_: [
                                        swift.functionArgument({ value: swift.Expression.stringLiteral(val.original) })
                                    ]
                                }),
                            boolean: (val) =>
                                swift.Expression.methodCall({
                                    target: swift.Expression.reference("JSONValue"),
                                    methodName: "bool",
                                    arguments_: [swift.functionArgument({ value: swift.Expression.boolLiteral(val) })]
                                }),
                            integer: (val) =>
                                swift.Expression.methodCall({
                                    target: swift.Expression.reference("JSONValue"),
                                    methodName: "number",
                                    arguments_: [swift.functionArgument({ value: swift.Expression.numberLiteral(val) })]
                                }),
                            uint: (val) =>
                                swift.Expression.methodCall({
                                    target: swift.Expression.reference("JSONValue"),
                                    methodName: "number",
                                    arguments_: [swift.functionArgument({ value: swift.Expression.numberLiteral(val) })]
                                }),
                            uint64: (val) =>
                                swift.Expression.methodCall({
                                    target: swift.Expression.reference("JSONValue"),
                                    methodName: "number",
                                    arguments_: [swift.functionArgument({ value: swift.Expression.numberLiteral(val) })]
                                }),
                            long: (val) =>
                                swift.Expression.methodCall({
                                    target: swift.Expression.reference("JSONValue"),
                                    methodName: "number",
                                    arguments_: [swift.functionArgument({ value: swift.Expression.numberLiteral(val) })]
                                }),
                            float: (val) =>
                                swift.Expression.methodCall({
                                    target: swift.Expression.reference("JSONValue"),
                                    methodName: "number",
                                    arguments_: [swift.functionArgument({ value: swift.Expression.numberLiteral(val) })]
                                }),
                            double: (val) =>
                                swift.Expression.methodCall({
                                    target: swift.Expression.reference("JSONValue"),
                                    methodName: "number",
                                    arguments_: [swift.functionArgument({ value: swift.Expression.numberLiteral(val) })]
                                }),
                            bigInteger: (val) =>
                                swift.Expression.methodCall({
                                    target: swift.Expression.reference("JSONValue"),
                                    methodName: "string",
                                    arguments_: [swift.functionArgument({ value: swift.Expression.stringLiteral(val) })]
                                }),
                            date: (val) =>
                                swift.Expression.methodCall({
                                    target: swift.Expression.reference("JSONValue"),
                                    methodName: "string",
                                    arguments_: [swift.functionArgument({ value: swift.Expression.stringLiteral(val) })]
                                }),
                            datetime: (val) =>
                                swift.Expression.methodCall({
                                    target: swift.Expression.reference("JSONValue"),
                                    methodName: "string",
                                    arguments_: [
                                        swift.functionArgument({
                                            value: swift.Expression.stringLiteral(val.raw ?? val.datetime.toISOString())
                                        })
                                    ]
                                }),
                            base64: (val) =>
                                swift.Expression.methodCall({
                                    target: swift.Expression.reference("JSONValue"),
                                    methodName: "string",
                                    arguments_: [swift.functionArgument({ value: swift.Expression.stringLiteral(val) })]
                                }),
                            uuid: (val) =>
                                swift.Expression.methodCall({
                                    target: swift.Expression.reference("JSONValue"),
                                    methodName: "string",
                                    arguments_: [swift.functionArgument({ value: swift.Expression.stringLiteral(val) })]
                                }),
                            _other: () => swift.Expression.nop()
                        });
                    },
                    map: (mapContainer) => {
                        return swift.Expression.methodCall({
                            target: swift.Expression.reference("JSONValue"),
                            methodName: "object",
                            arguments_: [
                                swift.functionArgument({
                                    value: swift.Expression.dictionaryLiteral({
                                        entries: mapContainer.map.map((kvPair) => [
                                            this.generateJSONValueExampleResponse(kvPair.key),
                                            this.generateJSONValueExampleResponse(kvPair.value)
                                        ]),
                                        multiline: true
                                    })
                                })
                            ],
                            multiline: true
                        });
                    },
                    set: (setContainer) => {
                        return swift.Expression.methodCall({
                            target: swift.Expression.reference("JSONValue"),
                            methodName: "array",
                            arguments_: [
                                swift.functionArgument({
                                    value: swift.Expression.arrayLiteral({
                                        elements: setContainer.set.map((element) =>
                                            this.generateJSONValueExampleResponse(element)
                                        ),
                                        multiline: setContainer.set.length > 1 ? true : undefined
                                    })
                                })
                            ]
                        });
                    },
                    nullable: (nullableContainer) => {
                        if (nullableContainer.nullable == null) {
                            return swift.Expression.enumCaseShorthand("null");
                        }
                        return this.generateJSONValueExampleResponse(nullableContainer.nullable);
                    },
                    optional: (optionalContainer) => {
                        if (optionalContainer.optional == null) {
                            return swift.Expression.enumCaseShorthand("null");
                        }
                        return this.generateJSONValueExampleResponse(optionalContainer.optional);
                    },
                    list: (listContainer) => {
                        return swift.Expression.methodCall({
                            target: swift.Expression.reference("JSONValue"),
                            methodName: "array",
                            arguments_: [
                                swift.functionArgument({
                                    value: swift.Expression.arrayLiteral({
                                        elements: listContainer.list.map((element) =>
                                            this.generateJSONValueExampleResponse(element)
                                        ),
                                        multiline: true
                                    })
                                })
                            ]
                        });
                    },
                    _other: () => swift.Expression.nop()
                }),
            primitive: (examplePrimitive) =>
                examplePrimitive._visit({
                    string: (escapedString) =>
                        swift.Expression.methodCall({
                            target: swift.Expression.reference("JSONValue"),
                            methodName: "string",
                            arguments_: [
                                swift.functionArgument({
                                    value: swift.Expression.stringLiteral(escapedString.original)
                                })
                            ]
                        }),
                    boolean: (bool) =>
                        swift.Expression.methodCall({
                            target: swift.Expression.reference("JSONValue"),
                            methodName: "bool",
                            arguments_: [swift.functionArgument({ value: swift.Expression.boolLiteral(bool) })]
                        }),
                    integer: (value) =>
                        swift.Expression.methodCall({
                            target: swift.Expression.reference("JSONValue"),
                            methodName: "number",
                            arguments_: [swift.functionArgument({ value: swift.Expression.numberLiteral(value) })]
                        }),
                    uint: (value) =>
                        swift.Expression.methodCall({
                            target: swift.Expression.reference("JSONValue"),
                            methodName: "number",
                            arguments_: [swift.functionArgument({ value: swift.Expression.numberLiteral(value) })]
                        }),
                    uint64: (value) =>
                        swift.Expression.methodCall({
                            target: swift.Expression.reference("JSONValue"),
                            methodName: "number",
                            arguments_: [swift.functionArgument({ value: swift.Expression.numberLiteral(value) })]
                        }),
                    long: (value) =>
                        swift.Expression.methodCall({
                            target: swift.Expression.reference("JSONValue"),
                            methodName: "number",
                            arguments_: [swift.functionArgument({ value: swift.Expression.numberLiteral(value) })]
                        }),
                    float: (value) =>
                        swift.Expression.methodCall({
                            target: swift.Expression.reference("JSONValue"),
                            methodName: "number",
                            arguments_: [swift.functionArgument({ value: swift.Expression.numberLiteral(value) })]
                        }),
                    double: (value) =>
                        swift.Expression.methodCall({
                            target: swift.Expression.reference("JSONValue"),
                            methodName: "number",
                            arguments_: [swift.functionArgument({ value: swift.Expression.numberLiteral(value) })]
                        }),
                    bigInteger: (value) =>
                        swift.Expression.methodCall({
                            target: swift.Expression.reference("JSONValue"),
                            methodName: "string",
                            arguments_: [swift.functionArgument({ value: swift.Expression.stringLiteral(value) })]
                        }),
                    date: (value) =>
                        swift.Expression.methodCall({
                            target: swift.Expression.reference("JSONValue"),
                            methodName: "string",
                            arguments_: [swift.functionArgument({ value: swift.Expression.stringLiteral(value) })]
                        }),
                    datetime: (value) =>
                        swift.Expression.methodCall({
                            target: swift.Expression.reference("JSONValue"),
                            methodName: "string",
                            arguments_: [
                                swift.functionArgument({
                                    value: swift.Expression.stringLiteral(value.raw ?? value.datetime.toISOString())
                                })
                            ]
                        }),
                    base64: (value) =>
                        swift.Expression.methodCall({
                            target: swift.Expression.reference("JSONValue"),
                            methodName: "string",
                            arguments_: [swift.functionArgument({ value: swift.Expression.stringLiteral(value) })]
                        }),
                    uuid: (value) =>
                        swift.Expression.methodCall({
                            target: swift.Expression.reference("JSONValue"),
                            methodName: "string",
                            arguments_: [swift.functionArgument({ value: swift.Expression.stringLiteral(value) })]
                        }),
                    _other: () => swift.Expression.nop()
                }),
            named: (exampleNamedType) => {
                return exampleNamedType.shape._visit({
                    alias: (exampleAliasType) => {
                        return this.generateJSONValueExampleResponse(exampleAliasType.value);
                    },
                    enum: (exampleEnumType) => {
                        return swift.Expression.methodCall({
                            target: swift.Expression.reference("JSONValue"),
                            methodName: "string",
                            arguments_: [
                                swift.functionArgument({
                                    value: swift.Expression.stringLiteral(exampleEnumType.value.wireValue)
                                })
                            ]
                        });
                    },
                    object: (exampleObjectType) => {
                        return swift.Expression.methodCall({
                            target: swift.Expression.reference("JSONValue"),
                            methodName: "object",
                            arguments_: [
                                swift.functionArgument({
                                    value: swift.Expression.dictionaryLiteral({
                                        entries: exampleObjectType.properties
                                            .filter((property) => property.value.jsonExample !== undefined)
                                            .map((property) => [
                                                swift.Expression.stringLiteral(property.name.wireValue),
                                                this.generateJSONValueExampleResponse(property.value)
                                            ]),
                                        multiline: true
                                    })
                                })
                            ],
                            multiline: true
                        });
                    },
                    union: () => {
                        // For unions, fall back to using the JSON example directly
                        return this.generateUnknownExampleResponse(exampleNamedType.typeName);
                    },
                    undiscriminatedUnion: (exampleUnionType) => {
                        return this.generateJSONValueExampleResponse(exampleUnionType.singleUnionType);
                    },
                    _other: () => swift.Expression.nop()
                });
            },
            unknown: (val) => {
                return this.generateUnknownExampleResponse(val);
            },
            _other: () => swift.Expression.nop()
        });
    }

    private generateUnknownExampleResponse(val: unknown): swift.Expression {
        if (val === null) {
            return swift.Expression.memberAccess({
                target: swift.Expression.reference("JSONValue"),
                memberName: "value"
            });
        }
        if (typeof val === "string") {
            return swift.Expression.methodCall({
                target: swift.Expression.reference("JSONValue"),
                methodName: "string",
                arguments_: [swift.functionArgument({ value: swift.Expression.stringLiteral(val) })]
            });
        }
        if (typeof val === "number") {
            return swift.Expression.methodCall({
                target: swift.Expression.reference("JSONValue"),
                methodName: "number",
                arguments_: [swift.functionArgument({ value: swift.Expression.numberLiteral(val) })]
            });
        }
        if (typeof val === "boolean") {
            return swift.Expression.methodCall({
                target: swift.Expression.reference("JSONValue"),
                methodName: "bool",
                arguments_: [swift.functionArgument({ value: swift.Expression.boolLiteral(val) })]
            });
        }
        if (Array.isArray(val)) {
            return swift.Expression.methodCall({
                target: swift.Expression.reference("JSONValue"),
                methodName: "array",
                arguments_: [
                    swift.functionArgument({
                        value: swift.Expression.arrayLiteral({
                            elements: val.map((element) => this.generateUnknownExampleResponse(element)),
                            multiline: true
                        })
                    })
                ]
            });
        }
        if (typeof val === "object") {
            return swift.Expression.methodCall({
                target: swift.Expression.reference("JSONValue"),
                methodName: "object",
                arguments_: [
                    swift.functionArgument({
                        value: swift.Expression.dictionaryLiteral({
                            entries: Object.entries(val).map(([key, value]) => [
                                swift.Expression.stringLiteral(key),
                                this.generateUnknownExampleResponse(value)
                            ]),
                            multiline: true
                        })
                    })
                ],
                multiline: true
            });
        }
        throw new Error(`Unknown value: ${JSON.stringify(val)}`);
    }

    /**
     * Formats the response body for the mock HTTP stub.
     *
     * The Swift SDK handles different response types differently:
     * - For String responses: It directly converts raw data to string (no JSON decoding)
     * - For Data responses: It returns the raw data directly
     * - For other types (Date, UUID, CalendarDate, etc.): It uses JSON decoding
     *
     * So we need to:
     * - For primitive string types: Return the raw string value
     * - For other types: Return JSON-encoded value
     */
    private formatResponseBody(exampleTypeRef: ExampleTypeReference): string {
        // Check if this is a primitive string type (or an alias to a primitive string)
        if (this.isStringResponseType(exampleTypeRef)) {
            // For string responses, return the raw string value (no JSON encoding)
            return typeof exampleTypeRef.jsonExample === "string"
                ? exampleTypeRef.jsonExample
                : JSON.stringify(exampleTypeRef.jsonExample, null, 2);
        }
        // For all other types, use JSON encoding
        return JSON.stringify(exampleTypeRef.jsonExample, null, 2);
    }

    /**
     * Checks if the response type is a primitive string type.
     * This includes:
     * - Direct primitive string types
     * - Aliases to primitive string types
     * - Base64 types (which are strings in Swift)
     */
    private isStringResponseType(exampleTypeRef: ExampleTypeReference): boolean {
        return exampleTypeRef.shape._visit({
            primitive: (primitive) => {
                return primitive._visit({
                    string: () => true,
                    base64: () => true,
                    // All other primitives need JSON encoding
                    integer: () => false,
                    uint: () => false,
                    uint64: () => false,
                    long: () => false,
                    float: () => false,
                    double: () => false,
                    boolean: () => false,
                    date: () => false,
                    datetime: () => false,
                    uuid: () => false,
                    bigInteger: () => false,
                    _other: () => false
                });
            },
            named: (namedType) => {
                // Check if this is an alias to a string type
                return namedType.shape._visit({
                    alias: (aliasType) => this.isStringResponseType(aliasType.value),
                    // All other named types need JSON encoding
                    enum: () => false,
                    object: () => false,
                    union: () => false,
                    undiscriminatedUnion: () => false,
                    _other: () => false
                });
            },
            container: () => false,
            unknown: () => false,
            _other: () => false
        });
    }
}
