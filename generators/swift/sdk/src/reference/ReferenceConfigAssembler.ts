import { ReferenceConfigBuilder } from "@fern-api/base-generator";
import { assertNever } from "@fern-api/core-utils";
import { swift } from "@fern-api/swift-codegen";
import { FernGeneratorCli } from "@fern-fern/generator-cli-sdk";
import { HttpEndpoint, HttpService, ServiceId } from "@fern-fern/ir-sdk/api";
import { ClientGeneratorContext, EndpointMethodGenerator } from "../generators";
import { SdkGeneratorContext } from "../SdkGeneratorContext";

interface SingleEndpointSnippet {
    exampleIdentifier: string | undefined;
    imports: string | undefined;
    endpointCall: string;
}

export class ReferenceConfigAssembler {
    private context: SdkGeneratorContext;

    public constructor(context: SdkGeneratorContext) {
        this.context = context;
    }

    public buildReferenceConfigBuilder(): ReferenceConfigBuilder {
        const builder = new ReferenceConfigBuilder();

        Object.entries(this.context.ir.services).forEach(([serviceId, service]) => {
            const section =
                this.context.ir.rootPackage.service === serviceId
                    ? builder.addRootSection()
                    : builder.addSection({ title: this.getReferenceSectionTitle(service) });
            const endpoints = this.getEndpointReferencesForService({ serviceId, service });
            for (const endpoint of endpoints) {
                section.addEndpoint(endpoint);
            }
        });

        return builder;
    }

    private getReferenceSectionTitle(service: HttpService): string {
        // TODO(kafkas): Confirm this is correct
        return (
            service.displayName ?? service.name.fernFilepath.allParts.map((part) => part.pascalCase.safeName).join(" ")
        );
    }

    private getEndpointReferencesForService({
        serviceId,
        service
    }: {
        serviceId: ServiceId;
        service: HttpService;
    }): FernGeneratorCli.EndpointReference[] {
        return service.endpoints
            .map((endpoint) => {
                const example =
                    endpoint.userSpecifiedExamples[0]?.example ?? endpoint.autogeneratedExamples[0]?.example;
                if (!example) {
                    // skip endpoints that don't have an example
                    return undefined;
                }
                // const singleEndpointSnippet = this.context.snippetGenerator.getSingleEndpointSnippet({
                //     endpoint,
                //     example
                // });

                // if (!singleEndpointSnippet) {
                //     // skip endpoints that don't have a snippet
                //     return undefined;
                // }
                // const endpointSignatureInfo = this.context.endpointGenerator.getEndpointSignatureInfo({
                //     serviceId,
                //     endpoint
                // });
                const endpointContainer = this.context.getEndpointContainer(endpoint);
                if (endpointContainer.type === "none") {
                    throw new Error(`Internal error; missing package or subpackage for endpoint ${endpoint.id}`);
                }
                const clientGeneratorContext = new ClientGeneratorContext({
                    packageOrSubpackage:
                        endpointContainer.type === "root-package"
                            ? endpointContainer.package
                            : endpointContainer.subpackage,
                    sdkGeneratorContext: this.context
                });
                const endpointMethodGenerator = new EndpointMethodGenerator({
                    clientGeneratorContext,
                    sdkGeneratorContext: this.context
                });
                const endpointMethod = endpointMethodGenerator.generateMethod(endpoint);
                return this.getEndpointReference({
                    serviceId,
                    service,
                    endpoint,
                    endpointMethod,
                    // TODO(kafkas): Implement
                    singleEndpointSnippet: {
                        imports: "Foundation",
                        exampleIdentifier: "example",
                        endpointCall: "doSomething()"
                    }
                });
            })
            .filter((endpoint): endpoint is FernGeneratorCli.EndpointReference => !!endpoint);
    }

    private getEndpointReference({
        serviceId,
        service,
        endpoint,
        endpointMethod,
        singleEndpointSnippet
    }: {
        serviceId: ServiceId;
        service: HttpService;
        endpoint: HttpEndpoint;
        endpointMethod: swift.Method;
        singleEndpointSnippet: SingleEndpointSnippet;
    }): FernGeneratorCli.EndpointReference {
        const { methodName, leadingParts } = this.context.getEndpointMethodDetails(endpoint);
        return {
            title: {
                snippetParts: [
                    {
                        text: ["client", ...leadingParts].join(".") + "."
                    },
                    {
                        text: methodName,
                        location: {
                            path: this.getSubclientFilepath(endpoint)
                        }
                    },
                    {
                        text: this.getReferenceEndpointInvocationParameters(endpointMethod)
                    }
                ],
                returnValue: { text: endpointMethod.returnType.toString() }
            },
            description: endpoint.docs,
            snippet: singleEndpointSnippet.endpointCall.trim(),
            parameters: endpointMethod.parameters.map((p) => ({
                name: p.unsafeName,
                type: p.type.toString(),
                required: !p.type.isOptional,
                description: p.docsContent,
                location: undefined // TODO(kafkas): Implement
            }))
        };
    }

    private getReferenceEndpointInvocationParameters(method: swift.Method): string {
        const paramsJoined = method.parameters.map((p) => `${p.unsafeName}: ${p.type.toString()}`).join(", ");
        return `(${paramsJoined})`;
    }

    private getSubclientFilepath(endpoint: HttpEndpoint): string {
        const endpointContainer = this.context.getEndpointContainer(endpoint);
        if (endpointContainer.type === "none") {
            throw new Error(`Internal error; missing package or subpackage for endpoint ${endpoint.id}`);
        } else if (endpointContainer.type === "root-package") {
            const rootClientName = this.context.project.symbolRegistry.getRootClientSymbolOrThrow();
            return `/${this.context.project.sourcesDirectory}/${rootClientName}.swift`;
        } else if (endpointContainer.type === "subpackage") {
            const subclientName = this.context.project.symbolRegistry.getSubClientSymbolOrThrow(
                endpointContainer.subpackageId
            );
            const fernFilepathDir = this.context.getDirectoryForFernFilepath(endpointContainer.subpackage.fernFilepath);
            return `/${this.context.project.sourcesDirectory}/${this.context.resourcesDirectory}/${fernFilepathDir}/${subclientName}.swift`;
        } else {
            assertNever(endpointContainer);
        }
    }
}
