import { ReferenceConfigBuilder } from "@fern-api/base-generator";
import { swift } from "@fern-api/swift-codegen";
import { FernGeneratorCli } from "@fern-fern/generator-cli-sdk";
import { HttpEndpoint, HttpService, ServiceId } from "@fern-fern/ir-sdk/api";
import { ClientGeneratorContext, EndpointMethodGenerator } from "../generators";
import { SdkGeneratorContext } from "../SdkGeneratorContext";

interface SingleEndpointSnippet {
    exampleIdentifier: string | undefined;
    imports: string | undefined;
    endpointCall: string;
}

interface EndpointSignatureInfo {
    returnType: swift.Type | undefined;
}

export class ReferenceConfigAssembler {
    private context: SdkGeneratorContext;

    public constructor(context: SdkGeneratorContext) {
        this.context = context;
    }

    public buildReferenceConfigBuilder(): ReferenceConfigBuilder {
        const builder = new ReferenceConfigBuilder();

        Object.entries(this.context.ir.services).forEach(([serviceId, service]) => {
            const section =
                this.context.ir.rootPackage.service === serviceId
                    ? builder.addRootSection()
                    : builder.addSection({ title: this.getReferenceSectionTitle(service) });
            const endpoints = this.getEndpointReferencesForService({ serviceId, service });
            for (const endpoint of endpoints) {
                section.addEndpoint(endpoint);
            }
        });

        return builder;
    }

    private getReferenceSectionTitle(service: HttpService): string {
        // TODO(kafkas): Confirm this is correct
        return (
            service.displayName ?? service.name.fernFilepath.allParts.map((part) => part.pascalCase.safeName).join(" ")
        );
    }

    private getEndpointReferencesForService({
        serviceId,
        service
    }: {
        serviceId: ServiceId;
        service: HttpService;
    }): FernGeneratorCli.EndpointReference[] {
        return service.endpoints
            .map((endpoint) => {
                const example =
                    endpoint.userSpecifiedExamples[0]?.example ?? endpoint.autogeneratedExamples[0]?.example;
                if (!example) {
                    // skip endpoints that don't have an example
                    return undefined;
                }
                // const singleEndpointSnippet = this.context.snippetGenerator.getSingleEndpointSnippet({
                //     endpoint,
                //     example
                // });

                // if (!singleEndpointSnippet) {
                //     // skip endpoints that don't have a snippet
                //     return undefined;
                // }
                // const endpointSignatureInfo = this.context.endpointGenerator.getEndpointSignatureInfo({
                //     serviceId,
                //     endpoint
                // });
                const package_ = this.context.getPackageOrSubpackageForEndpoint(endpoint);
                if (package_ == null) {
                    throw new Error(`Internal error; missing package or subpackage for endpoint ${endpoint.id}`);
                }
                const clientGeneratorContext = new ClientGeneratorContext({
                    packageOrSubpackage: package_,
                    sdkGeneratorContext: this.context
                });
                const endpointMethodGenerator = new EndpointMethodGenerator({
                    clientGeneratorContext,
                    sdkGeneratorContext: this.context
                });
                const endpointMethod = endpointMethodGenerator.generateMethod(endpoint);
                return this.getEndpointReference({
                    serviceId,
                    service,
                    endpoint,
                    endpointSignatureInfo: { returnType: endpointMethod.returnType },
                    endpointMethod,
                    singleEndpointSnippet: {
                        imports: "Foundation",
                        exampleIdentifier: "example",
                        endpointCall: "doSomething()"
                    }
                });
            })
            .filter((endpoint): endpoint is FernGeneratorCli.EndpointReference => !!endpoint);
    }

    private getEndpointReference({
        serviceId,
        service,
        endpoint,
        endpointSignatureInfo,
        endpointMethod,
        singleEndpointSnippet
    }: {
        serviceId: ServiceId;
        service: HttpService;
        endpoint: HttpEndpoint;
        endpointSignatureInfo: EndpointSignatureInfo;
        endpointMethod: swift.Method;
        singleEndpointSnippet: SingleEndpointSnippet;
    }): FernGeneratorCli.EndpointReference {
        const { methodName, leadingParts } = this.context.getEndpointMethodDetails(endpoint);
        return {
            title: {
                snippetParts: [
                    {
                        text: ["client", ...leadingParts].join(".") + "."
                    },
                    {
                        text: methodName,
                        location: {
                            path: this.getServiceFilepath({ serviceId, service })
                        }
                    },
                    {
                        text: this.getReferenceEndpointInvocationParameters(endpointSignatureInfo)
                    }
                ],
                returnValue: { text: endpointMethod.returnType.toString() }
            },
            description: endpoint.docs,
            snippet: singleEndpointSnippet.endpointCall.trim(),
            parameters: [] // TODO(kafkas): Implement
        };
    }

    private getReferenceEndpointInvocationParameters(endpointSignatureInfo: EndpointSignatureInfo): string {
        let result = "param123: String";
        // TODO(kafkas): Implement
        return `(${result})`;
    }

    private getServiceFilepath({ serviceId, service }: { serviceId: ServiceId; service: HttpService }): string {
        // TODO(kafkas): Implement
        return "path/to/service";
    }
}
