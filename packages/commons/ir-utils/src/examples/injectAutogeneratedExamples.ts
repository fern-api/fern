import { IntermediateRepresentation } from '@fern-api/ir-sdk'

import { generateEndpointExample as generateEndpointV1Example } from './v1/generateEndpointExample'
import { generateWebSocketExample as generateWebSocketV1Example } from './v1/generateWebSocketExample'
import { generateEndpointExample as generateEndpointV2Example } from './v2/generateEndpointExample'

export interface ExampleGenerationArgs {
    disabled: boolean
    includeOptionalRequestPropertyExamples?: boolean
    skipAutogenerationIfManualExamplesExist?: boolean
}

export function injectAutogeneratedExamples({
    ir,
    exampleGeneration
}: {
    ir: Omit<IntermediateRepresentation, 'sdkConfig' | 'subpackages' | 'rootPackage'>
    exampleGeneration: ExampleGenerationArgs
}): Omit<IntermediateRepresentation, 'sdkConfig' | 'subpackages' | 'rootPackage'> {
    for (const [_, service] of Object.entries(ir.services)) {
        for (const endpoint of service.endpoints) {
            if (
                endpoint.userSpecifiedExamples.length > 0 &&
                exampleGeneration?.skipAutogenerationIfManualExamplesExist === true
            ) {
                continue
            }
            const generatedExample = generateEndpointV1Example({
                ir,
                service,
                endpoint,
                typeDeclarations: ir.types,
                skipOptionalRequestProperties: exampleGeneration?.includeOptionalRequestPropertyExamples ? false : true,
                generationResponse: { type: 'success' }
            })
            if (generatedExample.type === 'failure') {
                continue
            }
            const { example } = generatedExample
            endpoint.autogeneratedExamples = [{ example }]
        }
    }
    for (const [_, channel] of Object.entries(ir.websocketChannels ?? {})) {
        if (channel.examples.length > 0 && exampleGeneration?.skipAutogenerationIfManualExamplesExist === true) {
            continue
        }
        const generatedExample = generateWebSocketV1Example({
            ir,
            channel,
            typeDeclarations: ir.types,
            skipOptionalRequestProperties: exampleGeneration?.includeOptionalRequestPropertyExamples ? false : true
        })
        if (generatedExample.type === 'failure') {
            continue
        }
        const { example } = generatedExample
        channel.examples = [...channel.examples, example]
    }
    return ir
}

export function injectAutogeneratedV2Examples({
    ir,
    exampleGeneration
}: {
    ir: Omit<IntermediateRepresentation, 'sdkConfig' | 'subpackages' | 'rootPackage'>
    exampleGeneration: ExampleGenerationArgs
}): Omit<IntermediateRepresentation, 'sdkConfig' | 'subpackages' | 'rootPackage'> {
    for (const [_, service] of Object.entries(ir.services)) {
        for (const endpoint of service.endpoints) {
            if (endpoint.v2Examples == null) {
                endpoint.v2Examples = {
                    userSpecifiedExamples: {},
                    autogeneratedExamples: {}
                }
            }
            const { userFullExamples, autoFullExamples } = generateEndpointV2Example({
                endpoint,
                ir,
                skipOptionalRequestProperties: exampleGeneration?.includeOptionalRequestPropertyExamples ? false : true
            })
            if (Object.keys(endpoint.v2Examples.userSpecifiedExamples).length > 0) {
                if (
                    Object.values(endpoint.v2Examples.userSpecifiedExamples).some(
                        (example) => example.request != null || example.response != null
                    )
                ) {
                    continue
                }
                const allCodeSamples = Object.values(endpoint.v2Examples.userSpecifiedExamples)
                    .filter((example) => example != null)
                    .flatMap((example) => example.codeSamples ?? [])

                for (const [name, example] of Object.entries(autoFullExamples)) {
                    autoFullExamples[name] = {
                        ...example,
                        codeSamples: allCodeSamples
                    }
                }

                for (const [name, example] of Object.entries(userFullExamples)) {
                    userFullExamples[name] = {
                        ...example,
                        codeSamples: allCodeSamples
                    }
                }
            }
            endpoint.v2Examples.autogeneratedExamples = autoFullExamples
            endpoint.v2Examples.userSpecifiedExamples = userFullExamples
        }
    }
    for (const [_, channel] of Object.entries(ir.websocketChannels ?? {})) {
        if (channel.examples.length > 0 && exampleGeneration?.skipAutogenerationIfManualExamplesExist === true) {
            continue
        }
        // TODO: We want to also use the v2 example generation for websocket generations.
        const generatedExample = generateWebSocketV1Example({
            ir,
            channel,
            typeDeclarations: ir.types,
            skipOptionalRequestProperties: exampleGeneration?.includeOptionalRequestPropertyExamples ? false : true
        })
        if (generatedExample.type === 'failure') {
            continue
        }
        const { example } = generatedExample
        channel.examples = [...channel.examples, example]
    }
    return ir
}
