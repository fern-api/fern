import { HttpEndpoint, HttpService, TypeDeclaration, TypeId, V2ValueExamples } from "@fern-api/ir-sdk";
import { isOptional } from "../utils/isTypeReferenceOptional";

export function generateParameterExamples({
    service,
    endpoint,
    typeDeclarations,
    skipOptionalRequestProperties
}: {
    service: HttpService;
    endpoint: HttpEndpoint;
    typeDeclarations: Record<TypeId, TypeDeclaration>;
    skipOptionalRequestProperties: boolean;
}): {
    pathParameters: V2ValueExamples;
    queryParameters: V2ValueExamples;
    headers: V2ValueExamples;
} {
    const result: {
        pathParameters: V2ValueExamples;
        queryParameters: V2ValueExamples;
        headers: V2ValueExamples;
    } = {
        pathParameters: {},
        queryParameters: {},
        headers: {}
    };

    for (const parameter of endpoint.pathParameters) {
        const userExamples = parameter.v2Examples?.userSpecifiedExamples ?? {};
        const autoExamples = parameter.v2Examples?.autogeneratedExamples ?? {};
        const firstUserExample = Object.values(userExamples)[0];
        const firstAutoExample = Object.values(autoExamples)[0];

        if (firstUserExample !== undefined) {
            result.pathParameters[parameter.name.originalName] = firstUserExample;
        } else if (firstAutoExample !== undefined) {
            result.pathParameters[parameter.name.originalName] = firstAutoExample;
        }
    }

    for (const parameter of endpoint.queryParameters) {
        if (skipOptionalRequestProperties && isOptional({ typeReference: parameter.valueType, typeDeclarations })) {
            continue;
        }
        
        const userExamples = parameter.v2Examples?.userSpecifiedExamples ?? {};
        const autoExamples = parameter.v2Examples?.autogeneratedExamples ?? {};
        const firstUserExample = Object.values(userExamples)[0];
        const firstAutoExample = Object.values(autoExamples)[0];

        if (firstUserExample !== undefined) {
            result.queryParameters[parameter.name.name.originalName] = firstUserExample;
        } else if (firstAutoExample !== undefined) {
            result.queryParameters[parameter.name.name.originalName] = firstAutoExample;
        }
    }

    for (const parameter of endpoint.headers) {
        if (skipOptionalRequestProperties && isOptional({ typeReference: parameter.valueType, typeDeclarations })) {
            continue;
        }
        
        const userExamples = parameter.v2Examples?.userSpecifiedExamples ?? {};
        const autoExamples = parameter.v2Examples?.autogeneratedExamples ?? {};
        const firstUserExample = Object.values(userExamples)[0];
        const firstAutoExample = Object.values(autoExamples)[0];

        if (firstUserExample !== undefined) {
            result.headers[parameter.name.name.originalName] = firstUserExample;
        } else if (firstAutoExample !== undefined) {
            result.headers[parameter.name.name.originalName] = firstAutoExample;
        }
    }

    return result;
}