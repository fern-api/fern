import { OpenAPIV3_1 } from "openapi-types";

import { constructHttpPath } from "@fern-api/ir-utils";

import { ErrorCollector } from "../../../ErrorCollector";
import { OpenAPIConverterContext3_1 } from "../../OpenAPIConverterContext3_1";
import { AbstractOperationConverter } from "./AbstractOperationConverter";

export declare namespace OperationConverter {
    export interface Args extends AbstractOperationConverter.Args {
        operation: OpenAPIV3_1.OperationObject;
        method: OpenAPIV3_1.HttpMethods;
        path: string;
    }
}

export class OperationConverter extends AbstractOperationConverter {
    constructor({ breadcrumbs, operation, method, path }: OperationConverter.Args) {
        super({ breadcrumbs, operation, method, path });
    }

    public convert({
        context,
        errorCollector
    }: {
        context: OpenAPIConverterContext3_1;
        errorCollector: ErrorCollector;
    }): AbstractOperationConverter.Output | undefined {
        const httpMethod = this.convertHttpMethod();
        if (httpMethod == null) {
            return undefined;
        }

        const { group, method } =
            this.computeGroupNameAndLocationFromExtensions({ context, errorCollector }) ??
            this.computeGroupNameFromTagAndOperationId({ context, errorCollector });

        const { headers, pathParameters, queryParameters } = this.convertParameters({ context, errorCollector });

        const requestBody = this.convertRequestBody({ context, errorCollector, group, method });
        if (requestBody === null) {
            return undefined;
        }

        const response = this.convertResponseBody({ context, errorCollector, group, method });

        return {
            group,
            endpoint: {
                id: `${group?.join(".") ?? ""}.${method}`,
                displayName: this.operation.summary,
                method: httpMethod,
                name: context.casingsGenerator.generateName(method),
                baseUrl: undefined,
                path: constructHttpPath(this.path),
                pathParameters,
                queryParameters,
                headers,
                requestBody,
                sdkRequest: undefined,
                response,
                errors: [],
                auth: this.operation.security != null || context.spec.security != null,
                availability: context.getAvailability({
                    node: this.operation,
                    breadcrumbs: this.breadcrumbs,
                    errorCollector
                }),
                docs: this.operation.description,
                userSpecifiedExamples: [],
                autogeneratedExamples: [],
                idempotent: false,
                basePath: undefined,
                fullPath: constructHttpPath(this.path),
                allPathParameters: pathParameters,
                pagination: undefined,
                transport: undefined
            },
            inlinedTypes: this.inlinedTypes
        };
    }
}
