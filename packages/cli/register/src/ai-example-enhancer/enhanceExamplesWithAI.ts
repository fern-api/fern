import { FdrAPI as FdrCjsSdk } from "@fern-api/fdr-sdk";
import { TaskContext } from "@fern-api/task-context";
import { writeFile } from "fs/promises";
import { OpenAIExampleEnhancer } from "./openaiClient";
import { AIExampleEnhancerConfig, ExampleEnhancementRequest } from "./types";

export async function enhanceExamplesWithAI(
    apiDefinition: FdrCjsSdk.api.v1.register.ApiDefinition,
    config: AIExampleEnhancerConfig,
    context: TaskContext
): Promise<FdrCjsSdk.api.v1.register.ApiDefinition> {
    if (!config.enabled) {
        context.logger.debug("AI example enhancement is disabled");
        return apiDefinition;
    }

    context.logger.info("Starting AI-powered example enhancement...");
    const enhancer = new OpenAIExampleEnhancer(config, context);

    // Track autogenerated examples that need enhancement
    const examplesEnhanced = { count: 0, total: 0 };
    const enhancementLog: Array<{
        endpoint: string;
        method: string;
        originalRequest?: any;
        originalResponse?: any;
        enhancedRequest?: any;
        enhancedResponse?: any;
    }> = [];

    // Recursively process all packages
    const enhancedApiDefinition = await enhancePackageExamples(
        apiDefinition,
        enhancer,
        context,
        examplesEnhanced,
        enhancementLog
    );

    context.logger.info(
        `AI example enhancement completed: ${examplesEnhanced.count}/${examplesEnhanced.total} examples enhanced`
    );

    // Write enhancement log to file
    if (enhancementLog.length > 0) {
        try {
            const logContent = JSON.stringify(enhancementLog, null, 2);
            await writeFile("ai_enhanced_examples.json", logContent, "utf-8");
            context.logger.info(`AI enhanced examples written to: ai_enhanced_examples.json`);
        } catch (error) {
            context.logger.warn(`Failed to write AI enhancement log: ${error}`);
        }
    }

    return enhancedApiDefinition;
}

async function enhancePackageExamples(
    apiDefinition: FdrCjsSdk.api.v1.register.ApiDefinition,
    enhancer: OpenAIExampleEnhancer,
    context: TaskContext,
    stats: { count: number; total: number },
    enhancementLog: Array<{
        endpoint: string;
        method: string;
        originalRequest?: any;
        originalResponse?: any;
        enhancedRequest?: any;
        enhancedResponse?: any;
    }>
): Promise<FdrCjsSdk.api.v1.register.ApiDefinition> {
    const enhancedSubpackages: Record<string, any> = {};

    // Process subpackages recursively
    for (const [packageId, subpackage] of Object.entries(apiDefinition.subpackages)) {
        const enhancedPackage = await enhancePackageEndpoints(
            subpackage as any,
            enhancer,
            context,
            stats,
            enhancementLog
        );
        // Preserve subpackage properties that are different from regular packages
        enhancedSubpackages[packageId] = {
            ...enhancedPackage,
            subpackageId: (subpackage as any).subpackageId,
            name: (subpackage as any).name,
            displayName: (subpackage as any).displayName,
            description: (subpackage as any).description
        };
    }

    // Process root package
    const enhancedRootPackage = await enhancePackageEndpoints(
        apiDefinition.rootPackage,
        enhancer,
        context,
        stats,
        enhancementLog
    );

    return {
        ...apiDefinition,
        subpackages: enhancedSubpackages,
        rootPackage: enhancedRootPackage
    };
}

async function enhancePackageEndpoints(
    pkg: FdrCjsSdk.api.v1.register.ApiDefinitionPackage,
    enhancer: OpenAIExampleEnhancer,
    context: TaskContext,
    stats: { count: number; total: number },
    enhancementLog: Array<{
        endpoint: string;
        method: string;
        originalRequest?: any;
        originalResponse?: any;
        enhancedRequest?: any;
        enhancedResponse?: any;
    }>
): Promise<FdrCjsSdk.api.v1.register.ApiDefinitionPackage> {
    const enhancedEndpoints = await Promise.all(
        pkg.endpoints.map(async (endpoint: any) => {
            return await enhanceEndpointExamples(endpoint, enhancer, context, stats, enhancementLog);
        })
    );

    return {
        ...pkg,
        endpoints: enhancedEndpoints
    };
}

async function enhanceEndpointExamples(
    endpoint: any,
    enhancer: OpenAIExampleEnhancer,
    context: TaskContext,
    stats: { count: number; total: number },
    enhancementLog: Array<{
        endpoint: string;
        method: string;
        originalRequest?: any;
        originalResponse?: any;
        enhancedRequest?: any;
        enhancedResponse?: any;
    }>
): Promise<any> {
    const enhancedExamples = await Promise.all(
        endpoint.examples.map(async (example: any) => {
            return await enhanceSingleExample(example, endpoint, enhancer, context, stats, enhancementLog);
        })
    );

    return {
        ...endpoint,
        examples: enhancedExamples
    };
}

async function enhanceSingleExample(
    example: any,
    endpoint: any,
    enhancer: OpenAIExampleEnhancer,
    context: TaskContext,
    stats: { count: number; total: number },
    enhancementLog: Array<{
        endpoint: string;
        method: string;
        originalRequest?: any;
        originalResponse?: any;
        enhancedRequest?: any;
        enhancedResponse?: any;
    }>
): Promise<any> {
    stats.total++;

    // Check if this example was autogenerated by looking for typical autogenerated patterns
    const isAutogenerated = isExampleAutogenerated(example);

    if (!isAutogenerated) {
        context.logger.debug(`Skipping user-provided example for ${endpoint.method} ${example.path}`);
        return example;
    }

    context.logger.debug(`Enhancing autogenerated example for ${endpoint.method} ${example.path}`);

    try {
        // Extract request and response examples
        const originalRequestExample = extractExampleValue(example.requestBodyV3);
        const originalResponseExample = extractExampleValue(example.responseBodyV3);

        // Only enhance if we have examples to work with
        if (!originalRequestExample && !originalResponseExample) {
            context.logger.debug(`No examples to enhance for ${endpoint.method} ${example.path}`);
            return example;
        }

        const enhancementRequest: ExampleEnhancementRequest = {
            endpointPath: example.path,
            method: endpoint.method,
            operationSummary: endpoint.summary,
            operationDescription: endpoint.description,
            originalRequestExample,
            originalResponseExample
        };

        const enhancedResult = await enhancer.enhanceExample(enhancementRequest);

        // Log the enhancement for debugging
        enhancementLog.push({
            endpoint: example.path,
            method: endpoint.method,
            originalRequest: originalRequestExample,
            originalResponse: originalResponseExample,
            enhancedRequest: enhancedResult.enhancedRequestExample,
            enhancedResponse: enhancedResult.enhancedResponseExample
        });

        // Update the example with enhanced data
        const enhancedExample: any = {
            ...example
        };

        // Update request body if enhanced
        if (enhancedResult.enhancedRequestExample && example.requestBodyV3) {
            enhancedExample.requestBody = enhancedResult.enhancedRequestExample;
            enhancedExample.requestBodyV3 = {
                ...example.requestBodyV3,
                value: enhancedResult.enhancedRequestExample
            };
        }

        // Update response body if enhanced
        if (enhancedResult.enhancedResponseExample && example.responseBodyV3) {
            enhancedExample.responseBody = enhancedResult.enhancedResponseExample;
            enhancedExample.responseBodyV3 = {
                ...example.responseBodyV3,
                value: enhancedResult.enhancedResponseExample
            };
        }

        stats.count++;
        context.logger.info(`âœ¨ Successfully enhanced example for ${endpoint.method} ${example.path}`);
        return enhancedExample;
    } catch (error) {
        context.logger.warn(`Failed to enhance example for ${endpoint.method} ${example.path}: ${error}`);
        return example;
    }
}

function isExampleAutogenerated(example: any): boolean {
    // Detect autogenerated examples by looking for typical patterns:
    // 1. Generic string values
    // 2. Simple numeric values (1, 2, etc.)
    // 3. Default boolean values
    // 4. Empty or minimal descriptions

    const hasGenericName = !example.name || example.name === "" || example.name === "Example";
    const hasEmptyDescription = !example.description || example.description === "";

    // Check if request/response bodies contain generic values
    const requestHasGenericValues = hasGenericValues(extractExampleValue(example.requestBodyV3));
    const responseHasGenericValues = hasGenericValues(extractExampleValue(example.responseBodyV3));

    return hasGenericName && hasEmptyDescription && (requestHasGenericValues || responseHasGenericValues);
}

function hasGenericValues(obj: unknown): boolean {
    if (obj === null || obj === undefined) {
        return false;
    }

    if (typeof obj === "string") {
        return obj === "string" || obj === "String" || obj === "";
    }

    if (typeof obj === "number") {
        return obj === 1 || obj === 0;
    }

    if (Array.isArray(obj)) {
        return obj.length > 0 && obj.some((item) => hasGenericValues(item));
    }

    if (typeof obj === "object") {
        return Object.values(obj).some((value) => hasGenericValues(value));
    }

    return false;
}

function extractExampleValue(bodyV3: any): unknown {
    if (!bodyV3) return undefined;

    switch (bodyV3.type) {
        case "json":
            return bodyV3.value;
        case "stream":
            return bodyV3.value;
        case "sse":
            return bodyV3.value;
        case "filename":
            return undefined; // Don't enhance file examples
        default:
            return (bodyV3 as any)?.value;
    }
}
