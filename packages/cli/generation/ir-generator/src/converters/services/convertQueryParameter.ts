import { RawSchemas } from "@fern-api/fern-definition-schema";
import { QueryParameter } from "@fern-api/ir-sdk";

import { FernFileContext } from "../../FernFileContext";
import { getTypeDeclarationName } from "../../utils/getTypeDeclarationName";
import { convertDeclaration } from "../convertDeclaration";
import { getCasingOverrides } from "../../utils/getCasingOverrides";

export function convertQueryParameter({
    file,
    queryParameterKey,
    queryParameter
}: {
    file: FernFileContext;
    queryParameterKey: string;
    queryParameter: RawSchemas.HttpQueryParameterSchema;
}): QueryParameter {
    const { name } = getQueryParameterName({ queryParameterKey, queryParameter });
    const valueType = file.parseTypeReference(queryParameter);
    return {
        ...convertDeclaration(queryParameter),
        name: file.casingsGenerator.generateNameAndWireValue({
            wireValue: queryParameterKey,
            name,
            opts: {
                casingOverrides: getCasingOverrides(queryParameter)
            }
        }),
        valueType,
        allowMultiple:
            typeof queryParameter !== "string" && queryParameter["allow-multiple"] != null
                ? queryParameter["allow-multiple"]
                : false,
        v2Examples: {
            userSpecifiedExamples: {},
            autogeneratedExamples: {}
        }
    };
}

export function getQueryParameterName({
    queryParameterKey,
    queryParameter
}: {
    queryParameterKey: string;
    queryParameter: RawSchemas.HttpQueryParameterSchema;
}): { name: string; wasExplicitlySet: boolean } {
    let name = getTypeDeclarationName(queryParameter);
    if (name) {
        return { name, wasExplicitlySet: true };
    }
    return { name: queryParameterKey, wasExplicitlySet: false };
}
