import { GeneratorName } from "@fern-api/configuration-loader";
import { IrSerialization } from "../../ir-serialization";
import { IrVersions } from "../../ir-versions";
import {
    GeneratorWasNeverUpdatedToConsumeNewIR,
    GeneratorWasNotCreatedYet,
    IrMigration
} from "../../types/IrMigration";

export const V60_TO_V59_MIGRATION: IrMigration<
    IrVersions.V60.ir.IntermediateRepresentation,
    IrVersions.V59.ir.IntermediateRepresentation
> = {
    laterVersion: "v60",
    earlierVersion: "v59",
    firstGeneratorVersionToConsumeNewIR: {
        [GeneratorName.TYPESCRIPT_NODE_SDK]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.TYPESCRIPT_BROWSER_SDK]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.TYPESCRIPT]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.TYPESCRIPT_SDK]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.TYPESCRIPT_EXPRESS]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.JAVA]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.JAVA_MODEL]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.JAVA_SDK]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.JAVA_SPRING]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.OPENAPI_PYTHON_CLIENT]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.OPENAPI]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.PYTHON_FASTAPI]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.PYTHON_PYDANTIC]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.PYTHON_SDK]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.STOPLIGHT]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.POSTMAN]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.GO_FIBER]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.GO_MODEL]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.GO_SDK]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.RUBY_MODEL]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.RUBY_SDK]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.CSHARP_MODEL]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.CSHARP_SDK]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.SWIFT_MODEL]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.SWIFT_SDK]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.PHP_MODEL]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.PHP_SDK]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.RUST_MODEL]: GeneratorWasNotCreatedYet,
        [GeneratorName.RUST_SDK]: GeneratorWasNotCreatedYet
    },
    jsonifyEarlierVersion: (ir) =>
        IrSerialization.V59.IntermediateRepresentation.jsonOrThrow(ir, {
            unrecognizedObjectKeys: "strip",
            skipValidation: true
        }),
    migrateBackwards: (v60): IrVersions.V59.ir.IntermediateRepresentation => {
        const irV59: IrVersions.V59.ir.IntermediateRepresentation = {
            ...v60,
            services: Object.fromEntries(
                Object.entries(v60.services).map(([key, service]): [string, IrVersions.V59.HttpService] => [
                    key,
                    {
                        ...service,
                        endpoints: service.endpoints.map(
                            (endpoint): IrVersions.V59.HttpEndpoint => ({
                                ...endpoint,
                                autogeneratedExamples: endpoint.autogeneratedExamples.map(
                                    (example): IrVersions.V59.AutogeneratedEndpointExample => ({
                                        ...example,
                                        example: {
                                            ...example.example,
                                            request:
                                                typeof example.example.request === "undefined"
                                                    ? undefined
                                                    : example.example.request._visit({
                                                          inlinedRequestBody: (
                                                              reqBody
                                                          ): IrVersions.V59.ExampleRequestBody =>
                                                              IrVersions.V59.ExampleRequestBody.inlinedRequestBody({
                                                                  ...reqBody,
                                                                  properties: reqBody.properties.map(
                                                                      (
                                                                          prop
                                                                      ): IrVersions.V59.ExampleInlinedRequestBodyProperty => ({
                                                                          ...prop,
                                                                          value: updateExampleTypeReference(prop.value)
                                                                      })
                                                                  )
                                                              }),
                                                          reference: (ref) =>
                                                              IrVersions.V59.ExampleRequestBody.reference(
                                                                  updateExampleTypeReference(ref)
                                                              ),
                                                          _other: () => undefined
                                                      }),
                                            response: example.example.response._visit({
                                                ok: (ok): IrVersions.V59.ExampleResponse =>
                                                    IrVersions.V59.ExampleResponse.ok(
                                                        ok._visit<IrVersions.V59.ExampleEndpointSuccessResponse>({
                                                            body: (body) =>
                                                                IrVersions.V59.ExampleEndpointSuccessResponse.body(
                                                                    typeof body === "undefined"
                                                                        ? undefined
                                                                        : updateExampleTypeReference(body)
                                                                ),
                                                            stream: (stream) =>
                                                                IrVersions.V59.ExampleEndpointSuccessResponse.stream(
                                                                    stream.map((item) =>
                                                                        updateExampleTypeReference(item)
                                                                    )
                                                                ),
                                                            sse: (sse) =>
                                                                IrVersions.V59.ExampleEndpointSuccessResponse.sse(
                                                                    sse.map((item) => ({
                                                                        ...item,
                                                                        data: updateExampleTypeReference(item.data)
                                                                    }))
                                                                ),
                                                            _other: () => ({ ...ok })
                                                        })
                                                    ),
                                                error: (error): IrVersions.V59.ExampleResponse =>
                                                    IrVersions.V59.ExampleResponse.error({
                                                        ...error,
                                                        body:
                                                            typeof error.body === "undefined"
                                                                ? undefined
                                                                : updateExampleTypeReference(error.body)
                                                    }),
                                                _other: (other) => ({ ...other }) as IrVersions.V59.ExampleResponse
                                            }),
                                            endpointHeaders: example.example.endpointHeaders.map((header) => ({
                                                ...header,
                                                value: updateExampleTypeReference(header.value)
                                            })),
                                            serviceHeaders: example.example.serviceHeaders.map((header) => ({
                                                ...header,
                                                value: updateExampleTypeReference(header.value)
                                            })),
                                            rootPathParameters: example.example.rootPathParameters.map((param) => ({
                                                ...param,
                                                value: updateExampleTypeReference(param.value)
                                            })),
                                            servicePathParameters: example.example.servicePathParameters.map(
                                                (param) => ({
                                                    ...param,
                                                    value: updateExampleTypeReference(param.value)
                                                })
                                            ),
                                            endpointPathParameters: example.example.endpointPathParameters.map(
                                                (param) => ({
                                                    ...param,
                                                    value: updateExampleTypeReference(param.value)
                                                })
                                            ),
                                            queryParameters: example.example.queryParameters.map((param) => ({
                                                ...param,
                                                value: updateExampleTypeReference(param.value)
                                            }))
                                        }
                                    })
                                ),
                                userSpecifiedExamples: endpoint.userSpecifiedExamples.map(
                                    (example): IrVersions.V59.UserSpecifiedEndpointExample => ({
                                        ...example,
                                        example:
                                            typeof example.example === "undefined"
                                                ? undefined
                                                : {
                                                      ...example.example,
                                                      request:
                                                          typeof example.example.request === "undefined"
                                                              ? undefined
                                                              : example.example.request._visit({
                                                                    inlinedRequestBody: (
                                                                        reqBody
                                                                    ): IrVersions.V59.ExampleRequestBody =>
                                                                        IrVersions.V59.ExampleRequestBody.inlinedRequestBody(
                                                                            {
                                                                                ...reqBody,
                                                                                properties: reqBody.properties.map(
                                                                                    (
                                                                                        prop
                                                                                    ): IrVersions.V59.ExampleInlinedRequestBodyProperty => ({
                                                                                        ...prop,
                                                                                        value: updateExampleTypeReference(
                                                                                            prop.value
                                                                                        )
                                                                                    })
                                                                                )
                                                                            }
                                                                        ),
                                                                    reference: (ref) =>
                                                                        IrVersions.V59.ExampleRequestBody.reference(
                                                                            updateExampleTypeReference(ref)
                                                                        ),
                                                                    _other: () => undefined
                                                                }),
                                                      response: example.example.response._visit({
                                                          ok: (ok): IrVersions.V59.ExampleResponse =>
                                                              IrVersions.V59.ExampleResponse.ok(
                                                                  ok._visit<IrVersions.V59.ExampleEndpointSuccessResponse>(
                                                                      {
                                                                          body: (body) =>
                                                                              IrVersions.V59.ExampleEndpointSuccessResponse.body(
                                                                                  typeof body === "undefined"
                                                                                      ? undefined
                                                                                      : updateExampleTypeReference(body)
                                                                              ),
                                                                          stream: (stream) =>
                                                                              IrVersions.V59.ExampleEndpointSuccessResponse.stream(
                                                                                  stream.map((item) =>
                                                                                      updateExampleTypeReference(item)
                                                                                  )
                                                                              ),
                                                                          sse: (sse) =>
                                                                              IrVersions.V59.ExampleEndpointSuccessResponse.sse(
                                                                                  sse.map((item) => ({
                                                                                      ...item,
                                                                                      data: updateExampleTypeReference(
                                                                                          item.data
                                                                                      )
                                                                                  }))
                                                                              ),
                                                                          _other: () => ({ ...ok })
                                                                      }
                                                                  )
                                                              ),
                                                          error: (error): IrVersions.V59.ExampleResponse =>
                                                              IrVersions.V59.ExampleResponse.error({
                                                                  ...error,
                                                                  body:
                                                                      typeof error.body === "undefined"
                                                                          ? undefined
                                                                          : updateExampleTypeReference(error.body)
                                                              }),
                                                          _other: (other) =>
                                                              ({ ...other }) as IrVersions.V59.ExampleResponse
                                                      }),
                                                      endpointHeaders: example.example.endpointHeaders.map(
                                                          (header) => ({
                                                              ...header,
                                                              value: updateExampleTypeReference(header.value)
                                                          })
                                                      ),
                                                      serviceHeaders: example.example.serviceHeaders.map((header) => ({
                                                          ...header,
                                                          value: updateExampleTypeReference(header.value)
                                                      })),
                                                      rootPathParameters: example.example.rootPathParameters.map(
                                                          (param) => ({
                                                              ...param,
                                                              value: updateExampleTypeReference(param.value)
                                                          })
                                                      ),
                                                      servicePathParameters: example.example.servicePathParameters.map(
                                                          (param) => ({
                                                              ...param,
                                                              value: updateExampleTypeReference(param.value)
                                                          })
                                                      ),
                                                      endpointPathParameters:
                                                          example.example.endpointPathParameters.map((param) => ({
                                                              ...param,
                                                              value: updateExampleTypeReference(param.value)
                                                          })),
                                                      queryParameters: example.example.queryParameters.map((param) => ({
                                                          ...param,
                                                          value: updateExampleTypeReference(param.value)
                                                      }))
                                                  }
                                    })
                                )
                            })
                        )
                    }
                ])
            ),
            types: Object.fromEntries(
                Object.entries(v60.types).map(([key, type]): [string, IrVersions.V59.TypeDeclaration] => [
                    key,
                    {
                        ...type,
                        userProvidedExamples: type.userProvidedExamples.map(
                            (example): IrVersions.V59.ExampleType => ({
                                ...example,
                                shape: updateExampleShape(example.shape)
                            })
                        ),
                        autogeneratedExamples: type.autogeneratedExamples.map(
                            (example): IrVersions.V59.ExampleType => ({
                                ...example,
                                shape: updateExampleShape(example.shape)
                            })
                        )
                    }
                ])
            )
        };
        return irV59;
    }
};

function updateExampleShape(shape: IrVersions.V60.ExampleTypeShape): IrVersions.V59.ExampleTypeShape {
    return shape._visit<IrVersions.V59.ExampleTypeShape>({
        alias: (alias) => IrVersions.V59.ExampleTypeShape.alias({ value: updateExampleTypeReference(alias.value) }),
        enum: () => ({ ...shape }),
        object: (obj) => IrVersions.V59.ExampleTypeShape.object(updateExampleObject(obj)),
        union: (union) =>
            IrVersions.V59.ExampleTypeShape.union({
                ...union,
                singleUnionType: {
                    ...union.singleUnionType,
                    shape: union.singleUnionType.shape._visit({
                        samePropertiesAsObject: (value): IrVersions.V59.ExampleSingleUnionTypeProperties =>
                            IrVersions.V59.ExampleSingleUnionTypeProperties.samePropertiesAsObject({
                                ...value,
                                object: updateExampleObject(value.object)
                            }),
                        singleProperty: (valueType): IrVersions.V59.ExampleSingleUnionTypeProperties =>
                            IrVersions.V59.ExampleSingleUnionTypeProperties.singleProperty(
                                updateExampleTypeReference(valueType)
                            ),
                        noProperties: () => ({ ...union.singleUnionType.shape }),
                        _other: () => ({ ...union.singleUnionType.shape })
                    })
                }
            }),
        undiscriminatedUnion: (union) =>
            IrVersions.V59.ExampleTypeShape.undiscriminatedUnion({
                ...union,
                singleUnionType: updateExampleTypeReference(union.singleUnionType)
            }),
        _other: () => ({ ...shape })
    });
}

function updateExampleObject(value: IrVersions.V60.ExampleObjectType): IrVersions.V59.ExampleObjectType {
    return {
        ...value,
        properties: value.properties.map((prop): IrVersions.V59.ExampleObjectProperty => {
            const migrationProp = {
                ...prop,
                value: updateExampleTypeReference(prop.value)
            };
            delete migrationProp.propertyAccess;
            return migrationProp;
        })
    };
}

function updateExampleTypeReference(value: IrVersions.V60.ExampleTypeReference): IrVersions.V59.ExampleTypeReference {
    return {
        ...value,
        shape: value.shape._visit<IrVersions.V59.ExampleTypeReferenceShape>({
            primitive: () => ({ ...value.shape }),
            container: (container) =>
                IrVersions.V59.ExampleTypeReferenceShape.container(updateExampleContainer(container)),
            unknown: () => ({ ...value.shape }),
            named: (named) =>
                IrVersions.V59.ExampleTypeReferenceShape.named({
                    ...named,
                    shape: updateExampleShape(named.shape)
                }),
            _other: () => ({ ...value.shape })
        })
    };
}

function updateExampleContainer(container: IrVersions.V60.ExampleContainer): IrVersions.V59.ExampleContainer {
    return container._visit<IrVersions.V59.ExampleContainer>({
        list: (list) =>
            IrVersions.V59.ExampleContainer.list({
                ...list,
                list: list.list.map((item) => updateExampleTypeReference(item))
            }),
        set: (set) =>
            IrVersions.V59.ExampleContainer.set({
                ...set,
                set: set.set.map((item) => updateExampleTypeReference(item))
            }),
        map: (map) =>
            IrVersions.V59.ExampleContainer.map({
                ...map,
                map: map.map.map((item) => ({
                    key: updateExampleTypeReference(item.key),
                    value: updateExampleTypeReference(item.value)
                }))
            }),
        optional: (optional) =>
            IrVersions.V59.ExampleContainer.optional({
                ...optional,
                optional: optional.optional ? updateExampleTypeReference(optional.optional) : undefined
            }),
        literal: () => ({ ...container }),
        nullable: (nullable) =>
            IrVersions.V59.ExampleContainer.nullable({
                ...nullable,
                nullable: nullable.nullable ? updateExampleTypeReference(nullable.nullable) : undefined
            }),
        _other: () => ({ ...container })
    });
}
