import { GeneratorName } from "@fern-api/configuration-loader";
import { visitDiscriminatedUnion } from "@fern-api/core-utils";
import { IrSerialization } from "../../ir-serialization";
import { IrVersions } from "../../ir-versions";
import { GeneratorWasNeverUpdatedToConsumeNewIR, IrMigration } from "../../types/IrMigration";

export const V62_TO_V61_MIGRATION: IrMigration<
    IrVersions.V62.ir.IntermediateRepresentation,
    IrVersions.V61.ir.IntermediateRepresentation
> = {
    laterVersion: "v62",
    earlierVersion: "v61",
    firstGeneratorVersionToConsumeNewIR: {
        [GeneratorName.TYPESCRIPT_NODE_SDK]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.TYPESCRIPT_BROWSER_SDK]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.TYPESCRIPT]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.TYPESCRIPT_SDK]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.TYPESCRIPT_EXPRESS]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.JAVA]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.JAVA_MODEL]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.JAVA_SDK]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.JAVA_SPRING]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.OPENAPI_PYTHON_CLIENT]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.OPENAPI]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.PYTHON_FASTAPI]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.PYTHON_PYDANTIC]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.PYTHON_SDK]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.STOPLIGHT]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.POSTMAN]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.GO_FIBER]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.GO_MODEL]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.GO_SDK]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.RUBY_MODEL]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.RUBY_SDK]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.CSHARP_MODEL]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.CSHARP_SDK]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.SWIFT_MODEL]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.SWIFT_SDK]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.PHP_MODEL]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.PHP_SDK]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.RUST_MODEL]: GeneratorWasNeverUpdatedToConsumeNewIR,
        [GeneratorName.RUST_SDK]: GeneratorWasNeverUpdatedToConsumeNewIR
    },
    jsonifyEarlierVersion: (ir) =>
        IrSerialization.V61.IntermediateRepresentation.jsonOrThrow(ir, {
            unrecognizedObjectKeys: "passthrough",
            skipValidation: true
        }),
    migrateBackwards: (
        v62: IrVersions.V62.IntermediateRepresentation
    ): IrVersions.V61.ir.IntermediateRepresentation => {
        return {
            ...v62,
            services: convertServices(v62.services)
        };
    }
};

function convertServices(
    services: Record<IrVersions.V62.commons.ServiceId, IrVersions.V62.http.HttpService>
): Record<IrVersions.V61.commons.ServiceId, IrVersions.V61.http.HttpService> {
    const convertedServices: Record<IrVersions.V61.commons.ServiceId, IrVersions.V61.http.HttpService> = {};
    for (const [serviceId, service] of Object.entries(services)) {
        convertedServices[serviceId] = {
            ...service,
            endpoints: service.endpoints.map((endpoint) => convertEndpoint(endpoint))
        };
    }
    return convertedServices;
}

function convertEndpoint(endpoint: IrVersions.V62.http.HttpEndpoint): IrVersions.V61.http.HttpEndpoint {
    return {
        ...endpoint,
        userSpecifiedExamples: endpoint.userSpecifiedExamples.map((example) => ({
            ...example,
            example: example.example != null ? convertExampleEndpointCall(example.example) : undefined
        })),
        autogeneratedExamples: endpoint.autogeneratedExamples.map((auto) => ({
            ...auto,
            example: convertExampleEndpointCall(auto.example)
        }))
    };
}

function convertExampleEndpointCall(
    example: IrVersions.V62.http.ExampleEndpointCall
): IrVersions.V61.http.ExampleEndpointCall {
    return {
        ...example,
        request: example.request != null ? convertExampleRequestBody(example.request) : undefined
    };
}

function convertExampleRequestBody(
    requestBody: IrVersions.V62.http.ExampleRequestBody
): IrVersions.V61.http.ExampleRequestBody | undefined {
    return visitDiscriminatedUnion(requestBody, "type")._visit<IrVersions.V61.http.ExampleRequestBody | undefined>({
        inlinedRequestBody: (inlined) => IrVersions.V61.http.ExampleRequestBody.inlinedRequestBody(inlined),
        reference: (reference) => IrVersions.V61.http.ExampleRequestBody.reference(reference),
        fileUpload: () => {
            // biome-ignore lint/suspicious/noConsole: Warning requested by reviewer to log when dropping fileUpload examples
            console.warn("Dropping fileUpload example during migration from v62 to v61 (not supported in v61)");
            return undefined;
        },
        _other: () => undefined
    });
}
