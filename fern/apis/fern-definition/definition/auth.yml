imports:
  commons: commons.yml

types:
  AuthSchemeKey: string
  AuthScope: string

  WithAuthSchema:
    properties:
      auth: optional<ApiAuthSchema>
      auth-schemes: optional<map<AuthSchemeKey, AuthSchemeDeclarationSchema>>

  ApiAuthSchema:
    discriminated: false
    union:
      - string
      - AuthSchemeReferenceSchema
      - AnyAuthSchemesSchema

  AuthSchemeReferenceSchema:
    extends:
      - commons.WithDocsSchema
    properties:
      scheme: string

  AnyAuthSchemesSchema:
    extends:
      - commons.WithDocsSchema
    properties:
      any: list<AnyAuthItem>

  AnyAuthItem:
    discriminated: false
    union:
      - string
      - AuthSchemeReferenceSchema

  AuthSchemeDeclarationSchema:
    discriminated: false
    union:
      - OAuthSchemeSchema
      - HeaderAuthSchemeSchema
      - BasicAuthSchemeSchema
      - BearerAuthSchemeSchema

  WithEnvironmentVariable:
    properties:
      env: optional<string>

  AuthVariable:
    extends:
      - WithEnvironmentVariable
      - commons.WithName

  HeaderAuthSchemeSchema:
    extends:
      - WithEnvironmentVariable
      - commons.WithName
      - commons.WithDocsSchema
    properties:
      header: string
      type:
        type: optional<string>
        docs: Defaults to string
      prefix: optional<string>

  BasicAuthSchemeSchema:
    extends:
      - commons.WithDocsSchema
    properties:
      scheme: literal<"basic">
      username: optional<AuthVariable>
      password: optional<AuthVariable>

  BearerAuthSchemeSchema:
    discriminated: false
    union:
      - TokenBearerAuthSchema
      - InferredBearerAuthSchema

  TokenBearerAuthSchema:
    extends:
      - commons.WithDocsSchema
    properties:
      scheme: literal<"bearer">
      token: optional<AuthVariable>

  InferredBearerAuthSchema:
    extends:
      - commons.WithDocsSchema
    properties:
      scheme: literal<"bearer">
      get-token: InferredGetTokenEndpointSchema
      refresh-token: optional<InferredRefreshTokenEndpointSchema>

  InferredGetTokenEndpointSchema:
    discriminated: false
    union:
      - string
      - InferredGetTokenEndpointSchemaObject

  InferredGetTokenEndpointSchemaObject:
    properties:
      endpoint:
        type: string
        docs: The endpoint to get the access token, such as 'auth.get_token'
      expiry-response-property:
        type: optional<string>
        docs: The property name for the expiry time in the response.
      authenticated-request-headers:
        type: optional<list<InferredAuthenticatedRequestHeader>>
        docs: The headers that will be set on HTTP requests when the inferred auth scheme is applied to an endpoint.

  InferredAuthenticatedRequestHeader:
    docs: A header that will be set on HTTP requests when the inferred auth scheme is applied to an endpoint.
      These are not headers for the authorization endpoint.
    properties:
      response-property:
        type: string
        docs: The property to retrieve the header value from the get token or refresh endpoint response.
      header-name:
        type: string
        docs: The header name to put the token in for any authenticated HTTP request.
      value-prefix:
        type: optional<string>
        docs: Commonly used for setting the `Authorization` scheme, but could be used for other things.

  InferredRefreshTokenEndpointSchema:
    discriminated: false
    union:
      - string
      - InferredRefreshTokenEndpointSchemaObject

  InferredRefreshTokenEndpointSchemaObject:
    properties:
      endpoint:
        type: string
        docs: The endpoint to refresh the access token, such as 'auth.refresh_token'
      expiry-response-property:
        type: optional<string>
        docs: The property name for the expiry time in the response.
      authenticated-request-headers:
        type: optional<list<InferredAuthenticatedRequestHeader>>
        docs: The headers that will be set on HTTP requests when the inferred auth scheme is applied to an endpoint. These will override the headers defined on the get-token endpoint.

  OAuthSchemeSchema:
    extends:
      - commons.WithDocsSchema
    properties:
      scheme: literal<"oauth">
      type: literal<"client-credentials">
      scopes: optional<list<AuthScope>>
      client-id-env: optional<string>
      client-secret-env: optional<string>
      token-prefix:
        type: optional<string>
        docs: Sets the token header value prefix. Defaults to 'Bearer'
      token-header:
        type: optional<string>
        docs: Sets the token header key name. Defaults to 'Authorization'
      get-token: OAuthGetTokenEndpointSchema
      refresh-token: optional<OAuthRefreshTokenEndpointSchema>

  OAuthGetTokenEndpointSchema:
    properties:
      endpoint:
        type: string
        docs: "The endpoint to get the access token, such as 'auth.get_token"
      request-properties:
        type: optional<OAuthAccessTokenRequestPropertiesSchema>
      response-properties:
        type: optional<OAuthAccessTokenResponsePropertiesSchema>

  OAuthAccessTokenRequestPropertiesSchema:
    properties:
      client-id:
        type: optional<string>
        docs: The property name for the client ID.
      client-secret:
        type: optional<string>
        docs: The property name for the client secret.
      scopes:
        type: optional<string>
        docs: The property name for the scopes.

  OAuthAccessTokenResponsePropertiesSchema:
    properties:
      access-token:
        type: optional<string>
        docs: The property name for the access token.
      expires-in:
        type: optional<string>
        docs: The property name for the expires in property.
      refresh-token:
        type: optional<string>
        docs: The property name for the refresh token

  OAuthRefreshTokenEndpointSchema:
    properties:
      endpoint:
        type: string
        docs: "The endpoint to refresh the access token, such as 'auth.refresh_token"
      request-properties:
        type: optional<OAuthRefreshTokenRequestPropertiesSchema>
      response-properties:
        type: optional<OAuthRefreshTokenResponsePropertiesSchema>

  OAuthRefreshTokenRequestPropertiesSchema:
    properties:
      refresh-token:
        type: string
        docs: The property name for the refresh token.

  OAuthRefreshTokenResponsePropertiesSchema:
    properties:
      access-token:
        type: optional<string>
        docs: The property name for the access token.
      expires-in:
        type: optional<string>
        docs: The property name for the expires in property.
      refresh-token:
        type: optional<string>
        docs: The property name for the refresh token.
