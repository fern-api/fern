name: Apply Update Seed Patches
description: Apply the patch artifacts that match the passed in pattern. Let the calling workflow apply patches by commit or PR depending on workflow.

inputs:
  patch-pattern:
    description: "Pattern to determine which artifacts to apply as patches."
    required: true
  checkout-ref:
    description: "Specific branch to checkout, depending on workflow. No input will checkout default branch in detached HEAD (okay for applying by PR workflow)"
    required: false
    default: ""
  allowed-generators:
    description: "Comma-separated list of generator names to include (e.g., 'ruby-model,python-sdk,ts-sdk'). If provided, only patches for these generators will be downloaded and applied."
    required: false
    default: ""

outputs:
  has-patches:
    description: "Whether or not there were patches found to update seed."
    value: ${{ steps.get-number-of-patches.outputs.HAS_PATCHES }}

runs:
  using: "composite"
  steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.checkout-ref }}

    - name: Create artifacts downloads directory
      shell: bash
      run: |
        DIRECTORY=artifacts
        if [ ! -d "$DIRECTORY" ]; then
          echo "'$DIRECTORY' does NOT exist, creating it now."
          mkdir $DIRECTORY
        else
          echo "WARNING: Directory '$DIRECTORY' already exists. Not an immediate error but could cause a problem downstream."
        fi

    - name: Download patches
      uses: actions/download-artifact@v5
      with:
        path: ./artifacts
        merge-multiple: true

    - name: Display content of a folder
      shell: bash
      run: |
        echo "Content of 'artifacts' folder:"
        ls -R artifacts/

    - name: Filter patches by allowed generators
      shell: bash
      run: |
        ALLOWED="${{ inputs.allowed-generators }}"
        if [ -n "$ALLOWED" ]; then
          echo "Post-download filtering: keeping only patches for allowed generators"
          IFS=',' read -ra GENERATORS <<< "$ALLOWED"
          
          ALLOWED_LIST=()
          for gen in "${GENERATORS[@]}"; do
            gen=$(echo "$gen" | xargs)
            ALLOWED_LIST+=("$gen")
          done
          
          for patch in artifacts/seed-*.patch; do
            if [ -f "$patch" ]; then
              filename=$(basename "$patch")
              gen_name=$(echo "$filename" | sed 's/^seed-\(.*\)-[0-9]*\.patch$/\1/')
              
              is_allowed=false
              for allowed_gen in "${ALLOWED_LIST[@]}"; do
                if [ "$gen_name" = "$allowed_gen" ]; then
                  is_allowed=true
                  break
                fi
              done
              
              if [ "$is_allowed" = false ]; then
                echo "Removing patch for non-allowed generator: $filename"
                rm -f "$patch"
              fi
            fi
          done
        else
          echo "No allowed-generators filter, keeping all downloaded patches"
        fi

    - name: Get number of patches
      shell: bash
      id: get-number-of-patches
      run: |
        PATCHES_PATTERN="${{ inputs.patch-pattern }}"
        file_count=$(find ./artifacts -type f -name "$PATCHES_PATTERN" | wc -l)
        echo "Number of patches after filtering: $file_count"
        if [ "$file_count" -gt 0 ]; then
          echo "HAS_PATCHES=true" >> $GITHUB_OUTPUT
        else
          echo "HAS_PATCHES=false" >> $GITHUB_OUTPUT
        fi

    - name: Apply patches
      shell: bash
      if: ${{ steps.get-number-of-patches.outputs.HAS_PATCHES == 'true' }}
      run: |
        PATCHES_PATTERN="${{ inputs.patch-pattern }}"
        git apply artifacts/$PATCHES_PATTERN
