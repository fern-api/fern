name: Run Seed Process
description: Run whole process for seed tests

inputs:
  sdk-name:
    description: The name of the SDK to get the test matrix for
    required: true
  generator-path:
    description: The path to the generator to run
    required: true
  fixtures-to-run:
    description: The fixtures to run, as JSON
    required: true
  skip-scripts:
    description: Whether to skip running scripts during seed generation
    required: false
    default: "false"
  job-index:
    description: The index of the job (when parallelized in a matrix strategy)
    required: true
  collect-metrics:
    description: Whether to collect metrics
    required: false
    default: "false"
  determinism-exclude-paths:
    description: "JSON array of paths to exclude from determinism verification step, typically package manager/lock files"
    required: false
    default: '["seed/*/.mock/*"]'

outputs:
  start_time:
    description: The start time of the seed tests, used for metric collection
    value: ${{ steps.start-seed-timer.outputs.start_time }}
  end_time:
    description: The end time of the seed tests, used for metric collection
    value: ${{ steps.end-seed-timer.outputs.end_time }}
  test_result:
    description: The result of the seed tests (success or failure)
    value: ${{ steps.run-seed.outcome }}
  failed_fixtures:
    description: List of failed fixtures from this test run
    value: ${{ steps.capture-failures.outputs.failed_fixtures }}

runs:
  using: "composite"
  steps:
    - name: Record seed start time
      id: start-seed-timer
      shell: bash
      run: |
        echo "start_time=$EPOCHSECONDS" >> $GITHUB_OUTPUT

    - name: Echo package
      shell: bash
      run: echo '${{ inputs.fixtures-to-run }}' | jq .

    # Format for seed tests
    - name: JSON to String
      id: json-to-string
      shell: bash
      run: |
        json_data='${{ inputs.fixtures-to-run }}'
        # Convert JSON array to space-separated string
        string_result=$(echo "$json_data" | jq -r '.[]' | tr '\n' ' ' | sed 's/ $//')
        echo "Generated string: '$string_result'"
        echo "as-string=$string_result" >> $GITHUB_OUTPUT

    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Run seed
      id: run-seed
      if: ${{ steps.json-to-string.outputs.as-string != 'leftovers' }}
      continue-on-error: true
      uses: ./.github/actions/cached-seed
      with:
        generator-name: ${{ inputs.sdk-name }}
        generator-path: ${{ inputs.generator-path }}
        fixtures-to-run: ${{ steps.json-to-string.outputs.as-string }}
        skip-scripts: ${{ inputs.skip-scripts }}

    - name: Handle Seed Leftover Tests
      id: run-seed-leftovers
      if: ${{ steps.json-to-string.outputs.as-string == 'leftovers' }}
      continue-on-error: true
      uses: ./.github/actions/handle-leftover-seed-tests
      with:
        sdk-name: ${{ inputs.sdk-name }}
        generator-path: ${{ inputs.generator-path }}

    - name: Capture test failures
      id: capture-failures
      if: always() && !cancelled()
      shell: bash
      run: |
        mkdir -p .seed-failures

        if [[ "${{ steps.run-seed.outcome }}" == "failure" ]] || [[ "${{ steps.run-seed-leftovers.outcome }}" == "failure" ]]; then
          echo "FAILED" > .seed-failures/status-${{ inputs.job-index }}.txt
          echo "sdk-name=${{ inputs.sdk-name }}" >> .seed-failures/status-${{ inputs.job-index }}.txt
          echo "job-index=${{ inputs.job-index }}" >> .seed-failures/status-${{ inputs.job-index }}.txt
          echo "fixtures=${{ inputs.fixtures-to-run }}" >> .seed-failures/status-${{ inputs.job-index }}.txt
          
          if [ -f .seed-test-output/failed-fixtures.txt ]; then
            cp .seed-test-output/failed-fixtures.txt .seed-failures/failed-fixtures-${{ inputs.job-index }}.txt
            FAILED_FIXTURES=$(cat .seed-test-output/failed-fixtures.txt)
            echo "failed_fixtures=$FAILED_FIXTURES" >> $GITHUB_OUTPUT
          else
            echo "failed_fixtures=FAILED" >> $GITHUB_OUTPUT
          fi
        else
          echo "SUCCESS" > .seed-failures/status-${{ inputs.job-index }}.txt
          echo "failed_fixtures=" >> $GITHUB_OUTPUT
        fi

    - name: Upload failure information
      if: always() && !cancelled()
      uses: actions/upload-artifact@v4
      with:
        name: seed-failures-${{ inputs.sdk-name }}-${{ inputs.job-index }}
        path: .seed-failures/
        retention-days: 1

    - name: Fail job if tests failed
      if: always() && !cancelled()
      shell: bash
      run: |
        if [[ "${{ steps.run-seed.outcome }}" == "failure" ]] || [[ "${{ steps.run-seed-leftovers.outcome }}" == "failure" ]]; then
          echo "Seed tests failed"
          exit 1
        fi

    - name: Record end time
      id: end-seed-timer
      # Log end time even if the tests fail
      if: always() && !cancelled()
      shell: bash
      run: |
        echo "end_time=$EPOCHSECONDS" >> $GITHUB_OUTPUT

    # Run after seed is built, do this separately so we can keep seed time collection limited to seed generation
    # Note: tests failing can be a cause of this reporting as non-deterministic
    - name: Verify Determinism
      id: verify-determinism
      if: ${{ always() && !cancelled() && inputs.collect-metrics == 'true' }}
      uses: ./.github/actions/verify-determinism
      with:
        determinism-exclude-paths: ${{ inputs.determinism-exclude-paths }}

    # Collect the outputs from this matrix iteration
    - name: Collect All Metrics
      # Save metrics even if the tests fail
      if: ${{ always() && !cancelled() && inputs.collect-metrics == 'true' }}
      uses: ./.github/actions/artifact-seed-metrics
      with:
        sdk-name: ${{ inputs.sdk-name }}
        job-index: ${{ inputs.job-index }}
        start-time: ${{ steps.start-seed-timer.outputs.start_time }}
        end-time: ${{ steps.end-seed-timer.outputs.end_time }}
        deterministic: ${{ steps.verify-determinism.outputs.deterministic}}
