name: "Sparse Checkout"
description: "Checkout with predefined sparse checkout configuration"
inputs:
  include:
    description: |
      Newline-separated list of what to include. Valid options:
      - source: Core source code directories
      - seed: Seed test data and fixtures
      - snapshots: Test snapshots
    required: true
  ref:
    description: "The branch, tag or SHA to checkout"
    required: false
  fetch-depth:
    description: "Number of commits to fetch. 0 indicates all history for all branches and tags"
    required: false

runs:
  using: "composite"
  steps:
    - name: Parse and validate include list
      id: parse
      shell: bash
      run: |
        # Read the input and split on newlines
        include_list="${{ inputs.include }}"

        # Initialize arrays for each category
        declare -a source_dirs=(
          ".github"
          ".husky"
          ".vscode"
          "docker"
          "fern" 
          "generators"
          "guides"
          "packages"
          "scripts"
          "shared"
          "test-definitions"
          "test-definitions-openapi"
          "test-fixtures"
          "windows"
        )

        declare -a seed_dirs=(
          "seed"
        )

        declare -a snapshot_dirs=(
          "snapshots"
        )

        # Use associative array to track unique directories
        declare -A unique_dirs

        # Process each line in the input
        while IFS= read -r line; do
          line=$(echo "$line" | xargs)  # Trim whitespace
          
          if [[ -z "$line" ]]; then
            continue  # Skip empty lines
          fi
          
          case "$line" in
            source)
              echo "Including source directories"
              for dir in "${source_dirs[@]}"; do
                unique_dirs["$dir"]=1
              done
              ;;
            seed)
              echo "Including seed directories"  
              for dir in "${seed_dirs[@]}"; do
                unique_dirs["$dir"]=1
              done
              ;;
            snapshots)
              echo "Including snapshot directories"
              for dir in "${snapshot_dirs[@]}"; do
                unique_dirs["$dir"]=1
              done
              ;;
            *)
              echo "ERROR: Invalid include option: '$line'"
              echo "Valid options: source, seed, snapshots"
              exit 1
              ;;
          esac
        done <<< "$include_list"

        # Build the final directory list
        final_dirs=""
        for dir in "${!unique_dirs[@]}"; do
          if [[ -z "$final_dirs" ]]; then
            final_dirs="$dir"
          else
            final_dirs="$final_dirs"$'\n'"$dir"
          fi
        done

        # Sort the directories for consistency
        final_dirs=$(echo "$final_dirs" | sort)

        echo "Final sparse checkout directories:"
        echo "$final_dirs"

        echo "sparse-paths<<EOF" >> $GITHUB_OUTPUT
        echo "$final_dirs" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Checkout
      uses: actions/checkout@v4
      with:
        sparse-checkout: ${{ steps.parse.outputs.sparse-paths }}
        ref: ${{ inputs.ref }}
        fetch-depth: ${{ inputs.fetch-depth }}
