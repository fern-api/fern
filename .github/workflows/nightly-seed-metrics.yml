name: Nightly Seed Metrics

on:
  # Runs every night at 9:00 AM UTC (5:00 AM ET)
  schedule:
    - cron: "0 9 * * *"
  # Runs when triggered manually to do so
  workflow_dispatch:

# Cancel previous workflows when another is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  trigger-seed-snapshot-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: ${{ github.ref == 'refs/heads/main' }}
    steps:
      # Note: this will trigger to the default branch of the repo, not the workflow_dispatch branch
      - name: Trigger Seed Tests with Metrics
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.FERN_GITHUB_PAT }}
          event-type: seed-test-metrics
          client-payload: '{"ref": "${{ github.ref }}"}'

  log-dispatch-rejection:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: ${{ github.ref != 'refs/heads/main' }}
    steps:
      - name: Log Dispatch Rejection
        run: |
          echo "Did not dispatch the seed metrics workflow. Only triggers from main are allowed for this workflow."
