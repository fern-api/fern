name: Test Remote vs Local Generation Parity

on:
  # Runs every morning at 8:00 AM Eastern Time (1:00 PM UTC)
  # schedule:
  #   - cron: "0 13 * * *"
  # Runs when triggered manually
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to test (defaults to main)"
        required: false
        default: "main"
        type: string

# Cancel previous workflows when another is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: "buildwithfern"

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || 'main' }}

      - name: Install
        uses: ./.github/actions/install

      - name: Compile
        run: pnpm compile

      - name: Build Fern CLI
        run: pnpm fern:build

      - name: Build Seed CLI
        run: pnpm seed:build

      - name: Cache Build Artifacts
        uses: actions/cache/save@v4
        with:
          path: |
            packages/cli/cli/dist
            packages/seed/dist
            node_modules
            packages/**/node_modules
            packages/**/dist
          key: build-${{ github.run_id }}

  test-remote-local-parity:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        generator:
          - ts-sdk
          - java-sdk
          - go-sdk
          - python-sdk
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || 'main' }}

      - name: Install
        uses: ./.github/actions/install

      - name: Restore Build Artifacts
        uses: actions/cache/restore@v4
        with:
          path: |
            packages/cli/cli/dist
            packages/seed/dist
            node_modules
            packages/**/node_modules
            packages/**/dist
          key: build-${{ github.run_id }}

      - name: Run Seed Test Remote-Local (${{ matrix.generator }})
        run: pnpm seed test-remote-local --generator ${{ matrix.generator }} --output-mode github
        env:
          FERN_TOKEN: ${{ secrets.FERN_FERN_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.TEST_REMOTE_LOCAL_GITHUB_TOKEN }}
