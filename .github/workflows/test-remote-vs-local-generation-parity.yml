name: Test Remote vs Local Generation Parity

on:
  # Runs every morning at 8:00 AM Eastern Time (1:00 PM UTC)
  # schedule:
  #   - cron: "0 13 * * *"
  # Runs when triggered manually
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to test (defaults to main)"
        required: false
        default: "main"
        type: string

# Cancel previous workflows when another is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: "buildwithfern"

jobs:
  test-remote-local-parity:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || 'main' }}

      - name: Install
        uses: ./.github/actions/install

      - name: Compile
        run: pnpm compile

      - name: Build Fern CLI
        run: pnpm fern:build

      - name: Build Seed CLI
        run: pnpm seed:build

      - name: Run Seed Test Remote-Local (GitHub Output Mode)
        run: pnpm seed test-remote-local --output-mode github
        env:
          FERN_TOKEN: ${{ secrets.FERN_FERN_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.TEST_REMOTE_LOCAL_GITHUB_TOKEN }}
