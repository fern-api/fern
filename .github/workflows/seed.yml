name: Seed Snapshot Tests

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/seed.yml'
      - 'packages/seed/**'
      - 'packages/ir-sdk/fern/apis/**'
      - 'packages/cli/generation/ir-generator/**'
      - 'test-definitions/**'
      - 'test-definitions-openapi/**'
      - 'generators/**'
      - 'seed/**'
  pull_request:
    branches:
      - main
    paths:
      - '.github/workflows/seed.yml'
      - 'packages/seed/**'
      - 'packages/ir-sdk/fern/apis/**'
      - 'packages/cli/generation/ir-generator/**'
      - 'test-definitions/**'
      - 'test-definitions-openapi/**'
      - 'generators/**'
      - 'seed/**'
  workflow_call:

# Cancel previous workflows on previous push
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      seed: ${{ steps.filter.outputs.seed }}
      ruby: ${{ steps.filter.outputs.ruby }}
      ruby-v2: ${{ steps.filter.outputs.ruby }}
      openapi: ${{ steps.filter.outputs.openapi }}
      python: ${{ steps.filter.outputs.python }}
      postman: ${{ steps.filter.outputs.postman }}
      java: ${{ steps.filter.outputs.java }}
      typescript: ${{ steps.filter.outputs.typescript }}
      go: ${{ steps.filter.outputs.go }}
      csharp: ${{ steps.filter.outputs.csharp }}
      php: ${{ steps.filter.outputs.php }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            seed:
              - '.github/workflows/seed.yml'
              - 'packages/seed/**'
              - 'packages/ir-sdk/fern/apis/**'
              - 'packages/cli/generation/ir-generator/**'
              - 'test-definitions/**'
              - 'test-definitions-openapi/**'
            ruby:
              - 'generators/ruby/**'
              - 'seed/ruby-sdk/**'
              - 'seed/ruby-model/**'
            ruby-v2:
              - 'generators/ruby-v2/**'
            openapi:
              - 'generators/openapi/**'
              - 'seed/openapi/**'
            python:
              - 'generators/python/**'
              - 'seed/pydantic/**'
              - 'seed/pydantic-v2/**'
              - 'seed/python-sdk/**'
              - 'seed/fastapi/**'
            postman:
              - 'generators/postman/**'
              - 'seed/postman/**'
            java:
              - 'generators/java/**'
              - 'seed/java-sdk/**'
              - 'seed/java-model/**'
              - 'seed/java-spring/**'
            typescript:
              - 'generators/typescript/**'
              - 'seed/ts-sdk/**'
              - 'seed/ts-express/**'
            go:
              - 'generators/go/**'
              - 'seed/go-sdk/**'
              - 'seed/go-model/**'
              - 'seed/go-fiber/**'
            csharp:
              - 'generators/csharp/**'
              - 'seed/csharp-sdk/**'
              - 'seed/csharp-model/**'
            php:
              - 'generators/php/**'
              - 'seed/php-sdk/**'
              - 'seed/php-model/**'
      - name: retry-on-failure
        if: failure() && steps.filter.outcome == 'failure' && fromJSON(github.run_attempt) < 3
        env:
          GH_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ github.token }}
          GH_DEBUG: api
        run: gh workflow run rerun.yml -F run_id=${{ github.run_id }}
        
  ruby-model:
    runs-on: Seed
    needs: changes
    if: ${{ needs.changes.outputs.ruby == 'true' ||  needs.changes.outputs.seed == 'true' }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Run seed
        uses: ./.github/actions/cached-seed
        with:
          generator-name: ruby-model
          generator-path: generators/ruby

  ruby-sdk:
    runs-on: Seed
    needs: changes
    if: ${{ needs.changes.outputs.ruby == 'true' ||  needs.changes.outputs.seed == 'true' }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Run seed
        uses: ./.github/actions/cached-seed
        with:
          generator-name: ruby-sdk
          generator-path: generators/ruby
