name: Publish Generator CLI

on:
  push:
    branches:
      # - main
      - jsklan/copy-generator-cli
    paths:
      - "packages/generator-cli/versions.yml"

env:
  PACKAGE_NAME: "@fern-api/generator-cli"
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: "buildwithfern"
  FERN_TOKEN: ${{ secrets.FERN_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.FERN_GITHUB_TOKEN }}
  NPM_TOKEN: ${{ secrets.FERN_NPM_TOKEN }}

permissions:
  id-token: write # Required for OIDC
  contents: read

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      has_new_version: ${{ steps.get_version.outputs.has_new_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: get_version
        run: |
          # Extract the new version from versions.yml
          new_version=$(head -n 10 packages/generator-cli/versions.yml | grep -A 1 "version:" | tail -n 1 | sed 's/.*version: //' | tr -d ' ')
          
          # Try to get previous version
          previous_version=""
          commit_count=$(git log --oneline -- packages/generator-cli/versions.yml | wc -l)
          
          if [ "${commit_count}" -gt 1 ]; then
            previous_commit=$(git log -n 2 --pretty=format:"%h" -- packages/generator-cli/versions.yml | tail -n 1)
            current_commit=$(git log -n 1 --pretty=format:"%h" -- packages/generator-cli/versions.yml)

            # Get the previous version of the file using the specific commit that last changed it
            if git show ${previous_commit}:packages/generator-cli/versions.yml > tmp_generator_cli_previous_versions.yml 2>/dev/null; then
              echo "Preview of the previous file (${previous_commit})"
              head tmp_generator_cli_previous_versions.yml

              # Extract the previous version
              previous_version=$(head -n 10 tmp_generator_cli_previous_versions.yml | grep -A 1 "version:" | tail -n 1 | sed 's/.*version: //' | tr -d ' ' || echo "")
            fi
          fi

          echo "Preview of the current file"
          head packages/generator-cli/versions.yml
          
          echo "Previous version: ${previous_version:-(none)}"
          echo "New version: ${new_version}"
          
          if [ -z "${previous_version}" ] || [ "${previous_version}" != "${new_version}" ]; then
            echo "has_new_version=true" >> $GITHUB_OUTPUT
            echo "version=${new_version}" >> $GITHUB_OUTPUT
            echo "Found new version: ${new_version}"
          else
            echo "has_new_version=false" >> $GITHUB_OUTPUT
            echo "version=" >> $GITHUB_OUTPUT
            echo "No new version detected"
          fi

  publish-cli:
    needs: check-version
    if: needs.check-version.outputs.has_new_version == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ“¥ Install
        uses: ./.github/actions/install
        with:
          registry-url: 'https://registry.npmjs.org'

      - name: Update npm
        run: npm install -g npm@latest

      - name: ðŸ§ª Build and test
        run: pnpm turbo codegen build test --filter=${{ env.PACKAGE_NAME }}

      - name: Publish generator-cli
        env:
          NODE_AUTH_TOKEN: ${{ env.NPM_TOKEN }}
          NEW_VERSION: ${{ needs.check-version.outputs.version }}
        run: |
          echo "ðŸš€ TEST MODE: Would publish generator-cli version ${NEW_VERSION} to npm"
          echo "   Package: ${PACKAGE_NAME}"
          echo "   Version: ${NEW_VERSION}"
          echo "   Tag: latest"
          # cd packages/generator-cli
          # mv package.json package.json.tmp
          # version_replace="s/0.0.0/${NEW_VERSION}/"
          # cat package.json.tmp| sed "${version_replace}" > package.json
          # rm -rf package.json.tmp
          # npm publish --access public --tag latest

  publish-sdks:
    needs: check-version
    if: needs.check-version.outputs.has_new_version == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ“¥ Install Fern
        run: npm install -g fern-api

      - name: Publish generator-cli
        env:
          FERN_TOKEN: ${{ secrets.FERN_TOKEN }}
          NEW_VERSION: ${{ needs.check-version.outputs.version }}
        run: |
          echo "ðŸš€ TEST MODE: Would publish generator-cli SDKs version ${NEW_VERSION}"
          echo "   API: generator-cli"
          echo "   Version: ${NEW_VERSION}"
          echo "   Group: sdk"
          # fern generate --api generator-cli --version "${NEW_VERSION}" --group sdk
