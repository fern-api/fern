/**
 * This file was auto-generated by Fern from our API Definition.
 */
package com.seed.endpointSecurityAuth;

import com.seed.endpointSecurityAuth.core.ClientOptions;
import com.seed.endpointSecurityAuth.core.Environment;
import com.seed.endpointSecurityAuth.core.InferredAuthTokenSupplier;
import com.seed.endpointSecurityAuth.core.OAuthTokenSupplier;
import com.seed.endpointSecurityAuth.resources.auth.AuthClient;
import java.util.Base64;
import java.util.HashMap;
import java.util.Map;
import java.util.Optional;
import okhttp3.OkHttpClient;

public class AsyncSeedEndpointSecurityAuthClientBuilder {
    private Optional<Integer> timeout = Optional.empty();

    private Optional<Integer> maxRetries = Optional.empty();

    private final Map<String, String> customHeaders = new HashMap<>();

    private String token = System.getenv("MY_TOKEN");

    private String apiKey = System.getenv("MY_API_KEY");

    private String username = System.getenv("MY_USERNAME");

    private String password = System.getenv("MY_PASSWORD");

    private String clientId = null;

    private String clientSecret = null;

    protected Environment environment;

    private OkHttpClient httpClient;

    /**
     * Sets token.
     * Defaults to the MY_TOKEN environment variable.
     */
    public AsyncSeedEndpointSecurityAuthClientBuilder token(String token) {
        this.token = token;
        return this;
    }

    /**
     * Sets apiKey.
     * Defaults to the MY_API_KEY environment variable.
     */
    public AsyncSeedEndpointSecurityAuthClientBuilder apiKey(String apiKey) {
        this.apiKey = apiKey;
        return this;
    }

    /**
     * Creates a builder that uses a pre-generated access token for authentication.
     * Use this when you already have a valid access token and want to bypass
     * the OAuth client credentials flow.
     *
     * @param token The access token to use for Authorization header
     * @return A builder configured for token authentication
     */
    public static _TokenAuth withToken(String token) {
        return new _TokenAuth(token);
    }

    /**
     * Creates a builder that uses OAuth client credentials for authentication.
     * The builder will automatically handle token acquisition and refresh.
     *
     * @param clientId The OAuth client ID
     * @param clientSecret The OAuth client secret
     * @return A builder configured for OAuth client credentials authentication
     */
    public static _CredentialsAuth withCredentials(String clientId, String clientSecret) {
        return new _CredentialsAuth(clientId, clientSecret);
    }

    public AsyncSeedEndpointSecurityAuthClientBuilder credentials(String username, String password) {
        this.username = username;
        this.password = password;
        return this;
    }

    /**
     * Sets clientId
     */
    public AsyncSeedEndpointSecurityAuthClientBuilder clientId(String clientId) {
        this.clientId = clientId;
        return this;
    }

    /**
     * Sets clientSecret
     */
    public AsyncSeedEndpointSecurityAuthClientBuilder clientSecret(String clientSecret) {
        this.clientSecret = clientSecret;
        return this;
    }

    public AsyncSeedEndpointSecurityAuthClientBuilder url(String url) {
        this.environment = Environment.custom(url);
        return this;
    }

    /**
     * Sets the timeout (in seconds) for the client. Defaults to 60 seconds.
     */
    public AsyncSeedEndpointSecurityAuthClientBuilder timeout(int timeout) {
        this.timeout = Optional.of(timeout);
        return this;
    }

    /**
     * Sets the maximum number of retries for the client. Defaults to 2 retries.
     */
    public AsyncSeedEndpointSecurityAuthClientBuilder maxRetries(int maxRetries) {
        this.maxRetries = Optional.of(maxRetries);
        return this;
    }

    /**
     * Sets the underlying OkHttp client
     */
    public AsyncSeedEndpointSecurityAuthClientBuilder httpClient(OkHttpClient httpClient) {
        this.httpClient = httpClient;
        return this;
    }

    /**
     * Add a custom header to be sent with all requests.
     * For headers that need to be computed dynamically or conditionally, use the setAdditional() method override instead.
     *
     * @param name The header name
     * @param value The header value
     * @return This builder for method chaining
     */
    public AsyncSeedEndpointSecurityAuthClientBuilder addHeader(String name, String value) {
        this.customHeaders.put(name, value);
        return this;
    }

    protected ClientOptions buildClientOptions() {
        ClientOptions.Builder builder = ClientOptions.builder();
        setEnvironment(builder);
        setAuthentication(builder);
        setHttpClient(builder);
        setTimeouts(builder);
        setRetries(builder);
        for (Map.Entry<String, String> header : this.customHeaders.entrySet()) {
            builder.addHeader(header.getKey(), header.getValue());
        }
        setAdditional(builder);
        return builder.build();
    }

    /**
     * Sets the environment configuration for the client.
     * Override this method to modify URLs or add environment-specific logic.
     *
     * @param builder The ClientOptions.Builder to configure
     */
    protected void setEnvironment(ClientOptions.Builder builder) {
        builder.environment(this.environment);
    }

    /**
     * Override this method to customize authentication.
     * This method is called during client options construction to set up authentication headers.
     *
     * @param builder The ClientOptions.Builder to configure
     *
     * Example:
     * <pre>{@code
     * &#64;Override
     * protected void setAuthentication(ClientOptions.Builder builder) {
     *     super.setAuthentication(builder); // Keep existing auth
     *     builder.addHeader("X-API-Key", this.apiKey);
     * }
     * }</pre>
     */
    protected void setAuthentication(ClientOptions.Builder builder) {
        if (this.token != null) {
            builder.addHeader("Authorization", "Bearer " + this.token);
        }
        builder.addHeader("X-API-Key", this.apiKey);
        if (this.username != null && this.password != null) {
            String unencodedToken = this.username + ":" + this.password;
            String encodedToken = Base64.getEncoder().encodeToString(unencodedToken.getBytes());
            builder.addHeader("Authorization", "Basic " + encodedToken);
        }
        if (this.clientId != null && this.clientSecret != null) {
            ClientOptions.Builder authClientOptionsBuilder =
                    ClientOptions.builder().environment(this.environment);
            AuthClient authClient = new AuthClient(authClientOptionsBuilder.build());
            InferredAuthTokenSupplier inferredAuthTokenSupplier =
                    new InferredAuthTokenSupplier(this.clientId, this.clientSecret, authClient);
            builder.addHeader(
                    "Authorization", () -> inferredAuthTokenSupplier.get().get("Authorization"));
        }
    }

    /**
     * Sets the request timeout configuration.
     * Override this method to customize timeout behavior.
     *
     * @param builder The ClientOptions.Builder to configure
     */
    protected void setTimeouts(ClientOptions.Builder builder) {
        if (this.timeout.isPresent()) {
            builder.timeout(this.timeout.get());
        }
    }

    /**
     * Sets the retry configuration for failed requests.
     * Override this method to implement custom retry strategies.
     *
     * @param builder The ClientOptions.Builder to configure
     */
    protected void setRetries(ClientOptions.Builder builder) {
        if (this.maxRetries.isPresent()) {
            builder.maxRetries(this.maxRetries.get());
        }
    }

    /**
     * Sets the OkHttp client configuration.
     * Override this method to customize HTTP client behavior (interceptors, connection pools, etc).
     *
     * @param builder The ClientOptions.Builder to configure
     */
    protected void setHttpClient(ClientOptions.Builder builder) {
        if (this.httpClient != null) {
            builder.httpClient(this.httpClient);
        }
    }

    /**
     * Override this method to add any additional configuration to the client.
     * This method is called at the end of the configuration chain, allowing you to add
     * custom headers, modify settings, or perform any other client customization.
     *
     * @param builder The ClientOptions.Builder to configure
     *
     * Example:
     * <pre>{@code
     * &#64;Override
     * protected void setAdditional(ClientOptions.Builder builder) {
     *     builder.addHeader("X-Request-ID", () -&gt; UUID.randomUUID().toString());
     *     builder.addHeader("X-Client-Version", "1.0.0");
     * }
     * }</pre>
     */
    protected void setAdditional(ClientOptions.Builder builder) {}

    /**
     * Override this method to add custom validation logic before the client is built.
     * This method is called at the beginning of the build() method to ensure the configuration is valid.
     * Throw an exception to prevent client creation if validation fails.
     *
     * Example:
     * <pre>{@code
     * &#64;Override
     * protected void validateConfiguration() {
     *     super.validateConfiguration(); // Run parent validations
     *     if (tenantId == null || tenantId.isEmpty()) {
     *         throw new IllegalStateException("tenantId is required");
     *     }
     * }
     * }</pre>
     */
    protected void validateConfiguration() {}

    public AsyncSeedEndpointSecurityAuthClient build() {
        if (apiKey == null) {
            throw new RuntimeException("Please provide apiKey or set the MY_API_KEY environment variable.");
        }
        validateConfiguration();
        return new AsyncSeedEndpointSecurityAuthClient(buildClientOptions());
    }

    public static final class _TokenAuth extends AsyncSeedEndpointSecurityAuthClientBuilder {
        private final String token;

        _TokenAuth(String token) {
            this.token = token;
        }

        @Override
        protected void setAuthentication(ClientOptions.Builder builder) {
            builder.addHeader("Authorization", "Bearer " + this.token);
        }
    }

    public static final class _CredentialsAuth extends AsyncSeedEndpointSecurityAuthClientBuilder {
        private final String clientId;

        private final String clientSecret;

        _CredentialsAuth(String clientId, String clientSecret) {
            this.clientId = clientId;
            this.clientSecret = clientSecret;
        }

        @Override
        public AsyncSeedEndpointSecurityAuthClient build() {
            validateConfiguration();
            ClientOptions baseOptions = buildClientOptions();
            AuthClient authClient = new AuthClient(baseOptions);
            OAuthTokenSupplier oAuthTokenSupplier =
                    new OAuthTokenSupplier(this.clientId, this.clientSecret, authClient);
            ClientOptions finalOptions = ClientOptions.Builder.from(baseOptions)
                    .addHeader("Authorization", oAuthTokenSupplier)
                    .build();
            return new AsyncSeedEndpointSecurityAuthClient(finalOptions);
        }
    }
}
