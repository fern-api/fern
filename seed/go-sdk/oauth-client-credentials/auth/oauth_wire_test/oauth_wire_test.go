// Code generated by Fern. DO NOT EDIT.

package oauth_wire_test

import (
	bytes "bytes"
	context "context"
	fern "github.com/oauth-client-credentials/fern"
	client "github.com/oauth-client-credentials/fern/client"
	option "github.com/oauth-client-credentials/fern/option"
	assert "github.com/stretchr/testify/assert"
	require "github.com/stretchr/testify/require"
	io "io"
	http "net/http"
	url "net/url"
	strings "strings"
	testing "testing"
)

// requestCapturingTransport captures HTTP requests for inspection in tests.
type requestCapturingTransport struct {
	capturedBody    []byte
	capturedHeaders http.Header
	capturedURL     string
	capturedMethod  string
}

func (t *requestCapturingTransport) RoundTrip(req *http.Request) (*http.Response, error) {
	t.capturedURL = req.URL.String()
	t.capturedHeaders = req.Header.Clone()
	t.capturedMethod = req.Method

	if req.Body != nil {
		body, err := io.ReadAll(req.Body)
		if err != nil {
			return nil, err
		}
		t.capturedBody = body
		req.Body = io.NopCloser(bytes.NewReader(body))
	}

	responseBody := `{
		"access_token": "test_access_token",
		"token_type": "Bearer",
		"expires_in": 3600
	}`

	return &http.Response{
		StatusCode: 200,
		Body:       io.NopCloser(strings.NewReader(responseBody)),
		Header: http.Header{
			"Content-Type": []string{"application/json"},
		},
	}, nil
}

// TestOAuthGetTokenFormEncodedBody verifies that the OAuth token request body
// is form URL encoded (not JSON) when the Content-Type is application/x-www-form-urlencoded.
func TestOAuthGetTokenFormEncodedBody(t *testing.T) {
	transport := &requestCapturingTransport{}
	httpClient := &http.Client{Transport: transport}

	c := client.NewClient(
		option.WithBaseURL("http://localhost:8080"),
		option.WithHTTPClient(httpClient),
		option.WithClientCredentials("test_client_id", "test_client_secret"),
	)

	request := &fern.GetTokenRequest{
		ClientId:     "test_client_id",
		ClientSecret: "test_client_secret",
	}

	_, err := c.Auth.GetTokenWithClientCredentials(context.Background(), request)
	if err != nil {
		t.Logf("GetToken returned error (may be expected in test): %v", err)
	}

	// Verify Content-Type header is form-urlencoded
	contentType := transport.capturedHeaders.Get("Content-Type")
	assert.Equal(t, "application/x-www-form-urlencoded", contentType,
		"Content-Type should be application/x-www-form-urlencoded")

	// Verify body is form-encoded (not JSON)
	bodyStr := string(transport.capturedBody)

	// Body should NOT start with { (JSON)
	assert.False(t, strings.HasPrefix(strings.TrimSpace(bodyStr), "{"),
		"Request body should not be JSON, got: %s", bodyStr)

	// Body should be parseable as form-urlencoded
	values, err := url.ParseQuery(bodyStr)
	require.NoError(t, err, "Body should be valid form-urlencoded")

	// Verify required OAuth parameters are present
	assert.NotEmpty(t, values.Get("client_id"), "client_id should be present")
	assert.NotEmpty(t, values.Get("client_secret"), "client_secret should be present")
}

// TestOAuthGetTokenCustomHeaders verifies that custom headers set on the client
// are included in the OAuth GetToken request.
func TestOAuthGetTokenCustomHeaders(t *testing.T) {
	transport := &requestCapturingTransport{}
	httpClient := &http.Client{Transport: transport}

	// Create custom headers
	customHeaders := http.Header{}
	customHeaders.Set("X-Custom-Header", "custom-value")
	customHeaders.Set("X-Sandbox-Auth", "sandbox-token-123")

	c := client.NewClient(
		option.WithBaseURL("http://localhost:8080"),
		option.WithHTTPClient(httpClient),
		option.WithClientCredentials("test_client_id", "test_client_secret"),
		option.WithHTTPHeader(customHeaders),
	)

	request := &fern.GetTokenRequest{
		ClientId:     "test_client_id",
		ClientSecret: "test_client_secret",
	}

	_, err := c.Auth.GetTokenWithClientCredentials(context.Background(), request)
	if err != nil {
		t.Logf("GetToken returned error (may be expected in test): %v", err)
	}

	// Verify custom headers are present in the captured request
	customHeader := transport.capturedHeaders.Get("X-Custom-Header")
	assert.Equal(t, "custom-value", customHeader,
		"X-Custom-Header should be included in GetToken request")

	sandboxHeader := transport.capturedHeaders.Get("X-Sandbox-Auth")
	assert.Equal(t, "sandbox-token-123", sandboxHeader,
		"X-Sandbox-Auth should be included in GetToken request")
}
