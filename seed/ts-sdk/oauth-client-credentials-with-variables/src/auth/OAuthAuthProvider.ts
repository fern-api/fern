// This file was auto-generated by Fern from our API Definition.

import { AuthClient } from "../api/resources/auth/client/Client.js";
import type { BaseClientOptions } from "../BaseClient.js";
import * as core from "../core/index.js";

export namespace OAuthAuthProvider {
    export interface Options extends BaseClientOptions {
        clientId: core.Supplier<string>;
        clientSecret: core.Supplier<string>;
    }
}

export class OAuthAuthProvider implements core.AuthProvider {
    private readonly BUFFER_IN_MINUTES: number = 2;
    private readonly _clientId: core.Supplier<string>;
    private readonly _clientSecret: core.Supplier<string>;
    private readonly _authClient: AuthClient;
    private _accessToken: string | undefined;
    private _expiresAt: Date;

    constructor(options: OAuthAuthProvider.Options) {
        this._clientId = options.clientId;

        this._clientSecret = options.clientSecret;

        this._authClient = new AuthClient(options);
        this._expiresAt = new Date();
    }

    public async getAuthRequest(): Promise<core.AuthRequest> {
        const token = await this.getToken();

        return {
            headers: {
                Authorization: `Bearer ${token}`,
            },
        };
    }

    private async getToken(): Promise<string> {
        if (this._accessToken && this._expiresAt > new Date()) {
            return this._accessToken;
        }
        return this.refresh();
    }

    private async refresh(): Promise<string> {
        const tokenResponse = await this._authClient.getTokenWithClientCredentials({
            client_id: await core.Supplier.get(this._clientId),
            client_secret: await core.Supplier.get(this._clientSecret),
        });

        this._accessToken = tokenResponse.access_token;
        this._expiresAt = this.getExpiresAt(tokenResponse.expires_in, this.BUFFER_IN_MINUTES);
        return this._accessToken;
    }

    private getExpiresAt(expiresInSeconds: number, bufferInMinutes: number): Date {
        const now = new Date();
        return new Date(now.getTime() + expiresInSeconds * 1000 - bufferInMinutes * 60 * 1000);
    }
}
