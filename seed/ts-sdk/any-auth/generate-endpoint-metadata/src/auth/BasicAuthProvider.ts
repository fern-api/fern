// This file was auto-generated by Fern from our API Definition.

import * as core from "../core/index.js";
import * as errors from "../errors/index.js";

const WRAPPER_PROPERTY = "basic" as const;
const USERNAME_PARAM = "username" as const;
const PASSWORD_PARAM = "password" as const;
const ENV_USERNAME = "MY_USERNAME" as const;
const ENV_PASSWORD = "MY_PASSWORD" as const;

export class BasicAuthProvider implements core.AuthProvider {
    private readonly options: BasicAuthProvider.Options;

    constructor(options: BasicAuthProvider.Options) {
        this.options = options;
    }

    public static canCreate(options: Partial<BasicAuthProvider.Options>): boolean {
        return (
            (options?.[WRAPPER_PROPERTY]?.[USERNAME_PARAM] != null || process.env?.[ENV_USERNAME] != null) &&
            (options?.[WRAPPER_PROPERTY]?.[PASSWORD_PARAM] != null || process.env?.[ENV_PASSWORD] != null)
        );
    }

    public async getAuthRequest({
        endpointMetadata,
    }: {
        endpointMetadata?: core.EndpointMetadata;
    } = {}): Promise<core.AuthRequest> {
        const username =
            (await core.EndpointSupplier.get(this.options[WRAPPER_PROPERTY]?.[USERNAME_PARAM], { endpointMetadata })) ??
            process.env?.[ENV_USERNAME];
        if (username == null) {
            throw new errors.SeedAnyAuthError({
                message: BasicAuthProvider.AUTH_CONFIG_ERROR_MESSAGE_USERNAME,
            });
        }

        const password =
            (await core.EndpointSupplier.get(this.options[WRAPPER_PROPERTY]?.[PASSWORD_PARAM], { endpointMetadata })) ??
            process.env?.[ENV_PASSWORD];
        if (password == null) {
            throw new errors.SeedAnyAuthError({
                message: BasicAuthProvider.AUTH_CONFIG_ERROR_MESSAGE_PASSWORD,
            });
        }

        const authHeader = core.BasicAuth.toAuthorizationHeader({
            username: username,
            password: password,
        });

        return {
            headers: authHeader != null ? { Authorization: authHeader } : {},
        };
    }
}

export namespace BasicAuthProvider {
    export const AUTH_SCHEME = "Basic" as const;
    export const AUTH_CONFIG_ERROR_MESSAGE: string =
        "Please provide username and password when initializing the client" as const;
    export const AUTH_CONFIG_ERROR_MESSAGE_USERNAME: string =
        `Please provide '${USERNAME_PARAM}' when initializing the client, or set the '${ENV_USERNAME}' environment variable` as const;
    export const AUTH_CONFIG_ERROR_MESSAGE_PASSWORD: string =
        `Please provide '${PASSWORD_PARAM}' when initializing the client, or set the '${ENV_PASSWORD}' environment variable` as const;
    export type Options = AuthOptions;
    export type AuthOptions = {
        [WRAPPER_PROPERTY]?: {
            [USERNAME_PARAM]?: core.EndpointSupplier<string> | undefined;
            [PASSWORD_PARAM]?: core.EndpointSupplier<string> | undefined;
        };
    };

    export function createInstance(options: Options): core.AuthProvider {
        return new BasicAuthProvider(options);
    }
}
