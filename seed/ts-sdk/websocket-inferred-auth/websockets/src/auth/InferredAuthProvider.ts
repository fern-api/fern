// This file was auto-generated by Fern from our API Definition.

import type { BaseClientOptions } from "../BaseClient.js";
import { AuthClient } from "../api/resources/auth/client/Client.js";
import * as core from "../core/index.js";

export class InferredAuthProvider implements core.AuthProvider {
    private readonly client: AuthClient;
    private readonly options: InferredAuthProvider.Options;

    constructor(options: InferredAuthProvider.Options) {
        this.options = options;
        this.client = new AuthClient(options);
    }

    public static canCreate(options: Partial<InferredAuthProvider.Options>): boolean {
        return options?.xApiKey != null && options?.clientId != null && options?.clientSecret != null;
    }

    public async getAuthRequest({ endpointMetadata }: {
            endpointMetadata?: core.EndpointMetadata;
        } = {}): Promise<core.AuthRequest> {

                return await this.getAuthRequestFromTokenEndpoint();
                
    }

    private async getAuthRequestFromTokenEndpoint(): Promise<core.AuthRequest> {
        const response = await this.client.getTokenWithClientCredentials({
            "X-Api-Key": await core.Supplier.get(this.options.xApiKey),
            client_id: await core.Supplier.get(this.options.clientId),
            client_secret: await core.Supplier.get(this.options.clientSecret),
            scope: await core.Supplier.get(this.options.scope)
        });
        return {
            headers: {
                Authorization: `Bearer ${response.access_token}`
            }
        };
    }
}

export namespace InferredAuthProvider {
    export const AUTH_SCHEME = "InferredAuthScheme" as const;
    export const AUTH_CONFIG_ERROR_MESSAGE: string = "Please provide xApiKey and clientId and clientSecret when initializing the client" as const;

    export interface AuthOptions {
        xApiKey: core.Supplier<string>;
        clientId: core.Supplier<string>;
        clientSecret: core.Supplier<string>;
        scope?: core.Supplier<string>;
    }

    export type Options = BaseClientOptions;

    export function createInstance(options: Options): core.AuthProvider {
        return new InferredAuthProvider(options);
    }
}
